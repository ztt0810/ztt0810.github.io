<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æ•°æ®å¢å¼º</title>
      <link href="2021/03/30/cv/%E2%95%A9%C2%A4%E2%95%9B%E2%96%8C%E2%95%98%D0%8E%E2%95%9F%E2%94%90%E2%95%99%D1%8B%E2%95%A4%E2%95%A1%E2%94%B4%E2%95%96trick/"/>
      <url>2021/03/30/cv/%E2%95%A9%C2%A4%E2%95%9B%E2%96%8C%E2%95%98%D0%8E%E2%95%9F%E2%94%90%E2%95%99%D1%8B%E2%95%A4%E2%95%A1%E2%94%B4%E2%95%96trick/</url>
      
        <content type="html"><![CDATA[<h1 id="yolov5ä¸­ç”¨åˆ°çš„æ•°æ®å¢å¼ºå’Œtrickæ€»ç»“ï¼ˆä¸Šï¼‰"><a href="#yolov5ä¸­ç”¨åˆ°çš„æ•°æ®å¢å¼ºå’Œtrickæ€»ç»“ï¼ˆä¸Šï¼‰" class="headerlink" title="yolov5ä¸­ç”¨åˆ°çš„æ•°æ®å¢å¼ºå’Œtrickæ€»ç»“ï¼ˆä¸Šï¼‰"></a>yolov5ä¸­ç”¨åˆ°çš„æ•°æ®å¢å¼ºå’Œtrickæ€»ç»“ï¼ˆä¸Šï¼‰</h1><p>yolov5ä¸­ç”¨åˆ°äº†è®¸å¤šæ•°æ®å¢å¼ºæ–¹æ³•å’Œtrickæ¥æé«˜æ¨¡å‹ç²¾åº¦ï¼Œå¦‚mosaic, cutout, augment imagespace, augment colorspaceï¼Œaugment hsv, ç¿»è½¬ï¼Œæ—‹è½¬ç­‰</p><h2 id="æ•°æ®å¢å¼º"><a href="#æ•°æ®å¢å¼º" class="headerlink" title="æ•°æ®å¢å¼º"></a>æ•°æ®å¢å¼º</h2><h3 id="ä¸€ã€Mosaic"><a href="#ä¸€ã€Mosaic" class="headerlink" title="ä¸€ã€Mosaic"></a>ä¸€ã€Mosaic</h3><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>Mosaicé€šè¿‡å°†å››å¼ è®­ç»ƒå›¾ç‰‡åˆå¹¶æˆä¸€å¼ ï¼Œç”±æ­¤å¯ä»¥æå‡æ¨¡å‹å¯¹å°ç›®æ ‡çš„æ£€æµ‹èƒ½åŠ›ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå°ç›®æ ‡å›¾ç‰‡åœ¨è®­ç»ƒé›†ä¸­çš„åˆ†å¸ƒå¹¶ä¸å‡åŒ€ï¼Œè¿™ä¹Ÿå¯¼è‡´äº†æ¨¡å‹å¯¹å°æ ·æœ¬çš„å­¦ä¹ ä¸å¤Ÿå……åˆ†ï¼Œå› æ­¤åœ¨é€šè¿‡mosaicæ“ä½œåï¼Œä½¿å¾—æ•°æ®é›†ä¸­å°ç›®æ ‡æ ·æœ¬æ•°é‡å¾—ä»¥å¢åŠ ï¼Œæ¯å¼ å›¾éƒ½æœ‰ä¸åŒç¨‹åº¦çš„ç¼©å°ï¼Œå³ä½¿æ²¡æœ‰å°ç›®æ ‡ï¼Œé€šè¿‡ç¼©å°ï¼ŒåŸæ¥çš„ç›®æ ‡å°ºå¯¸ä¹Ÿæ›´æ¥è¿‘å°ç›®æ ‡çš„å¤§å°ã€‚</p><h4 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_mosaic</span>(<span class="params">self, index</span>):</span></span><br><span class="line">    <span class="comment"># loads images in a 4-mosaic</span></span><br><span class="line"><span class="comment"># å°†å››å¼ å›¾ç‰‡åˆå¹¶æˆä¸€å¼ å›¾ç‰‡</span></span><br><span class="line">    labels4 = []</span><br><span class="line">    s = self.img_size</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># åœ¨å›¾ç‰‡ä¸­éšæœºé€‰å–ä¸€ä¸ªä¸­å¿ƒç‚¹ï¼Œä½œä¸ºå››å¼ å›¾ç‰‡æ‹¼æ¥çš„ä¸­å¿ƒç‚¹, self.mosaic_border = [-img_size // 2, img_size // 2]</span></span><br><span class="line">    yc, xc = [<span class="built_in">int</span>(random.uniform(-x, <span class="number">2</span> * s + x)) <span class="keyword">for</span> x <span class="keyword">in</span> self.mosaic_border]  <span class="comment"># mosaic center x, y</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#éšæœºæŒ‘é€‰ä¸‰å¼ è¢«é•¶åµŒå›¾ç‰‡ï¼Œé€šè¿‡indicesæ¥ç´¢å¼•</span></span><br><span class="line">    indices = [index] + [self. [random.randint(<span class="number">0</span>, self.n - <span class="number">1</span>)] <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]  <span class="comment"># 3 additional image indices</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, index <span class="keyword">in</span> <span class="built_in">enumerate</span>(indices):</span><br><span class="line">        <span class="comment"># Load imageï¼Œè¿”å›å›¾ç‰‡çŸ©é˜µï¼Œå›¾ç‰‡å®½å’Œé«˜</span></span><br><span class="line">        img, _, (h, w) = load_image(self, index)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># place img in img4 å°†4å¼ å›¾ç‰‡åˆæˆä¸ºä¸€å¼ ï¼Œåˆ†åˆ«æ”¾åœ¨å›¾åƒçš„å››ä¸ªä½ç½®</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:  <span class="comment"># top left</span></span><br><span class="line">            img4 = np.full((s * <span class="number">2</span>, s * <span class="number">2</span>, img.shape[<span class="number">2</span>]), <span class="number">114</span>, dtype=np.uint8)  <span class="comment"># base image with 4 tiles</span></span><br><span class="line">            x1a, y1a, x2a, y2a = <span class="built_in">max</span>(xc - w, <span class="number">0</span>), <span class="built_in">max</span>(yc - h, <span class="number">0</span>), xc, yc  <span class="comment"># xmin, ymin, xmax, ymax (large image)</span></span><br><span class="line">            x1b, y1b, x2b, y2b = w - (x2a - x1a), h - (y2a - y1a), w, h  <span class="comment"># xmin, ymin, xmax, ymax (small image)</span></span><br><span class="line">        <span class="keyword">elif</span> i == <span class="number">1</span>:  <span class="comment"># top right</span></span><br><span class="line">            x1a, y1a, x2a, y2a = xc, <span class="built_in">max</span>(yc - h, <span class="number">0</span>), <span class="built_in">min</span>(xc + w, s * <span class="number">2</span>), yc</span><br><span class="line">            x1b, y1b, x2b, y2b = <span class="number">0</span>, h - (y2a - y1a), <span class="built_in">min</span>(w, x2a - x1a), h</span><br><span class="line">        <span class="keyword">elif</span> i == <span class="number">2</span>:  <span class="comment"># bottom left</span></span><br><span class="line">            x1a, y1a, x2a, y2a = <span class="built_in">max</span>(xc - w, <span class="number">0</span>), yc, xc, <span class="built_in">min</span>(s * <span class="number">2</span>, yc + h)</span><br><span class="line">            x1b, y1b, x2b, y2b = w - (x2a - x1a), <span class="number">0</span>, w, <span class="built_in">min</span>(y2a - y1a, h)</span><br><span class="line">        <span class="keyword">elif</span> i == <span class="number">3</span>:  <span class="comment"># bottom right</span></span><br><span class="line">            x1a, y1a, x2a, y2a = xc, yc, <span class="built_in">min</span>(xc + w, s * <span class="number">2</span>), <span class="built_in">min</span>(s * <span class="number">2</span>, yc + h)</span><br><span class="line">            x1b, y1b, x2b, y2b = <span class="number">0</span>, <span class="number">0</span>, <span class="built_in">min</span>(w, x2a - x1a), <span class="built_in">min</span>(y2a - y1a, h)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">#æŠŠè¦åˆå¹¶å›¾ç‰‡æ”¾åˆ°å¤§çš„å›¾ç‰‡é‡Œ</span></span><br><span class="line">        img4[y1a:y2a, x1a:x2a] = img[y1b:y2b, x1b:x2b]  <span class="comment"># img4[ymin:ymax, xmin:xmax]</span></span><br><span class="line">        padw = x1a - x1b</span><br><span class="line">        padh = y1a - y1b</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Labels</span></span><br><span class="line">        labels = self.labels[index].copy()</span><br><span class="line">        <span class="keyword">if</span> labels.size:</span><br><span class="line">            <span class="comment"># å°†labelä»x, y, w, hè½¬æ¢æˆx1, y1, x2, y2</span></span><br><span class="line">            labels[:, <span class="number">1</span>:] = xywhn2xyxy(labels[:, <span class="number">1</span>:], w, h, padw, padh)  <span class="comment"># normalized xywh to pixel xyxy format</span></span><br><span class="line">        labels4.append(labels)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Concat/clip labels</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(labels4):</span><br><span class="line">        <span class="comment"># æŠŠå››å¼ å›¾ç‰‡çš„labelè¿›è¡Œåˆå¹¶</span></span><br><span class="line">        labels4 = np.concatenate(labels4, <span class="number">0</span>)</span><br><span class="line">        np.clip(labels4[:, <span class="number">1</span>:], <span class="number">0</span>, <span class="number">2</span> * s, out=labels4[:, <span class="number">1</span>:])  <span class="comment"># use with random_perspective</span></span><br><span class="line">        <span class="comment"># img4, labels4 = replicate(img4, labels4)  # replicate</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Augment  å¯¹å›¾ç‰‡åšä»¿å°„å˜æ¢æˆ–é€è§†å˜æ¢ï¼Œç”±self.hyp[&#x27;perspective&#x27;]å†³å®š</span></span><br><span class="line">    img4, labels4 = random_perspective(img4, labels4,</span><br><span class="line">                                       degrees=self.hyp[<span class="string">&#x27;degrees&#x27;</span>],</span><br><span class="line">                                       translate=self.hyp[<span class="string">&#x27;translate&#x27;</span>],</span><br><span class="line">                                       scale=self.hyp[<span class="string">&#x27;scale&#x27;</span>],</span><br><span class="line">                                       shear=self.hyp[<span class="string">&#x27;shear&#x27;</span>],</span><br><span class="line">                                       perspective=self.hyp[<span class="string">&#x27;perspective&#x27;</span>],</span><br><span class="line">                                       border=self.mosaic_border)  <span class="comment"># border to remove</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img4, labels4</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="äºŒã€letterbox"><a href="#äºŒã€letterbox" class="headerlink" title="äºŒã€letterbox"></a>äºŒã€letterbox</h3><h4 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œæ¨¡å‹çš„è¾“å…¥å°ºå¯¸éƒ½æ˜¯ä¸€ä¸ªå›ºå®šå€¼ï¼Œå¦‚yolov5ä¸ºï¼ˆ640ï¼Œ640ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œè®­ç»ƒé›†å›¾ç‰‡çš„å¤§å°éƒ½æ˜¯ä¸åŒçš„ï¼Œå› æ­¤éœ€è¦å¯¹å›¾ç‰‡çš„å°ºå¯¸è¿›è¡Œç»Ÿä¸€ï¼Œæ­¤æ—¶ï¼Œæˆ‘ä»¬é©¬ä¸Šä¼šæƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼Œcv2.resize()ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªå¾ˆå¤§çš„é—®é¢˜ï¼Œå®ƒä¼šç ´åå›¾ç‰‡çš„çºµæ¨ªæ¯”ï¼ˆaspect ratioï¼‰ï¼Œå¦‚æœå›¾ç‰‡çš„é•¿å’Œå®½ä¸ä¸ç›®æ ‡å°ºå¯¸æˆç›¸åŒæ¯”ä¾‹ï¼Œé‚£ä¹ˆå›¾ç‰‡å°±ä¼šå¤±çœŸï¼Œç»“æœå°±æ˜¯æˆ‘ä»¬çš„æ¨¡å‹ç²¾åº¦ä¼šæ”¶åˆ°å½±å“ã€‚è€Œletterboxå°±æ˜¯åœ¨ä¿æŒçºµæ¨ªæ¯”çš„å‰æä¸‹å¯¹å›¾åƒåšresizeï¼Œå…ˆresizeç„¶åæŒ‰éœ€è¦åœ¨å‘¨å›´padä¸Š0åƒç´ ã€‚è¯´ç™½äº†å°±æ˜¯å…ˆæŒ‰ç…§æ¯”ä¾‹resizeåˆ°ä¸€ä¸ªä¸ç›®æ ‡å°ºå¯¸ç›¸è¿‘çš„å¤§å°ï¼Œç„¶åé€šè¿‡padå°†å›¾ç‰‡å¡«å……åˆ°ç›®æ ‡å°ºå¯¸ã€‚</p><h4 id="ä»£ç åˆ†æ-1"><a href="#ä»£ç åˆ†æ-1" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">letterbox</span>(<span class="params">img, new_shape=(<span class="params"><span class="number">640</span>, <span class="number">640</span></span>), color=(<span class="params"><span class="number">114</span>, <span class="number">114</span>, <span class="number">114</span></span>), auto=<span class="literal">True</span>, scaleFill=<span class="literal">False</span>, scaleup=<span class="literal">True</span>, stride=<span class="number">32</span></span>):</span></span><br><span class="line">    <span class="comment"># Resize and pad image while meeting stride-multiple constraints</span></span><br><span class="line">    shape = img.shape[:<span class="number">2</span>]  <span class="comment"># current shape [height, width]</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(new_shape, <span class="built_in">int</span>):</span><br><span class="line">        new_shape = (new_shape, new_shape)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Scale ratio (new / old)</span></span><br><span class="line">    <span class="comment"># è®¡ç®—éœ€è¦resizeçš„æ¯”ä¾‹ï¼Œå–åŸå§‹å›¾ç‰‡å¤§å°ä¸ç›®æ ‡å°ºå¯¸é•¿å®½æ¯”å€¼é‡Œè¾ƒå°çš„ä¸€ä¸ª</span></span><br><span class="line">    r = <span class="built_in">min</span>(new_shape[<span class="number">0</span>] / shape[<span class="number">0</span>], new_shape[<span class="number">1</span>] / shape[<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># å¦‚æœåœ¨æµ‹è¯•çš„æ—¶å€™åŸå§‹å›¾ç‰‡å°ºå¯¸å°äºç›®æ ‡å°ºå¯¸ï¼Œåˆ™è¿›è¡Œç­‰æ¯”ä¾‹å˜æ¢ï¼Œè¿™æ˜¯ä¸ºäº†å¾—åˆ°æ›´é«˜çš„map</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> scaleup:  <span class="comment"># only scale down, do not scale up (for better test mAP)</span></span><br><span class="line">        r = <span class="built_in">min</span>(r, <span class="number">1.0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Compute padding</span></span><br><span class="line">    ratio = r, r  <span class="comment"># width, height ratios</span></span><br><span class="line">    <span class="comment"># è®¡ç®—æ–°å›¾ç‰‡æŒ‰æ¯”ä¾‹resizeçš„å¤§å°</span></span><br><span class="line">    new_unpad = <span class="built_in">int</span>(<span class="built_in">round</span>(shape[<span class="number">1</span>] * r)), <span class="built_in">int</span>(<span class="built_in">round</span>(shape[<span class="number">0</span>] * r))</span><br><span class="line">    <span class="comment"># è®¡ç®—é•¿å’Œå®½åˆ†åˆ«æœ‰å¤šå°‘åƒç´ éœ€è¦å¡«å……</span></span><br><span class="line">    dw, dh = new_shape[<span class="number">1</span>] - new_unpad[<span class="number">0</span>], new_shape[<span class="number">0</span>] - new_unpad[<span class="number">1</span>]  <span class="comment"># wh padding</span></span><br><span class="line">    <span class="keyword">if</span> auto:  <span class="comment"># minimum rectangle</span></span><br><span class="line">        dw, dh = np.mod(dw, stride), np.mod(dh, stride)  <span class="comment"># wh padding</span></span><br><span class="line">    <span class="keyword">elif</span> scaleFill:  <span class="comment"># stretch</span></span><br><span class="line">        dw, dh = <span class="number">0.0</span>, <span class="number">0.0</span></span><br><span class="line">        new_unpad = (new_shape[<span class="number">1</span>], new_shape[<span class="number">0</span>])</span><br><span class="line">       <span class="comment"># è®¡ç®—åŸå§‹å›¾ç‰‡å°ºå¯¸ä¸ç›®æ ‡å°ºå¯¸çš„çºµæ¨ªæ¯”</span></span><br><span class="line">        ratio = new_shape[<span class="number">1</span>] / shape[<span class="number">1</span>], new_shape[<span class="number">0</span>] / shape[<span class="number">0</span>]  <span class="comment"># width, height ratios</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†é•¿å’Œå®½åˆ†åˆ«åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œé•¿åˆ†æˆå·¦å³å¡«å……åˆ°å›¾ç‰‡ä¸­ï¼Œå®½åˆ†æˆä¸Šå’Œä¸‹å¡«å……åˆ°å›¾ç‰‡ä¸­</span></span><br><span class="line">    dw /= <span class="number">2</span>  <span class="comment"># divide padding into 2 sides</span></span><br><span class="line">    dh /= <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> shape[::-<span class="number">1</span>] != new_unpad:  <span class="comment"># resize</span></span><br><span class="line">        img = cv2.resize(img, new_unpad, interpolation=cv2.INTER_LINEAR)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># å¯¹å¡«å……å¤§å°å››èˆäº”å…¥å–æ•´</span></span><br><span class="line">    top, bottom = <span class="built_in">int</span>(<span class="built_in">round</span>(dh - <span class="number">0.1</span>)), <span class="built_in">int</span>(<span class="built_in">round</span>(dh + <span class="number">0.1</span>))</span><br><span class="line">    left, right = <span class="built_in">int</span>(<span class="built_in">round</span>(dw - <span class="number">0.1</span>)), <span class="built_in">int</span>(<span class="built_in">round</span>(dw + <span class="number">0.1</span>))</span><br><span class="line">    <span class="comment"># å¡«å……åƒç´ </span></span><br><span class="line">    img = cv2.copyMakeBorder(img, top, bottom, left, right, cv2.BORDER_CONSTANT, value=color)  <span class="comment"># add border</span></span><br><span class="line">    <span class="keyword">return</span> img, ratio, (dw, dh)</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€augment-hsv"><a href="#ä¸‰ã€augment-hsv" class="headerlink" title="ä¸‰ã€augment_hsv"></a>ä¸‰ã€augment_hsv</h3><p>å¯¹hsvè‰²å½©ç©ºé—´è¿›è¡Œå¢å¼º</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">r = np.random.uniform(-<span class="number">1</span>, <span class="number">1</span>, <span class="number">3</span>) * [hgain, sgain, vgain] + <span class="number">1</span>  <span class="comment"># random gains</span></span><br><span class="line">   hue, sat, val = cv2.split(cv2.cvtColor(img, cv2.COLOR_BGR2HSV))</span><br><span class="line">   dtype = img.dtype  <span class="comment"># uint8</span></span><br><span class="line"></span><br><span class="line">   x = np.arange(<span class="number">0</span>, <span class="number">256</span>, dtype=np.int16)</span><br><span class="line">   lut_hue = ((x * r[<span class="number">0</span>]) % <span class="number">180</span>).astype(dtype)</span><br><span class="line">   lut_sat = np.clip(x * r[<span class="number">1</span>], <span class="number">0</span>, <span class="number">255</span>).astype(dtype)</span><br><span class="line">   lut_val = np.clip(x * r[<span class="number">2</span>], <span class="number">0</span>, <span class="number">255</span>).astype(dtype)</span><br><span class="line"></span><br><span class="line">   img_hsv = cv2.merge((cv2.LUT(hue, lut_hue), cv2.LUT(sat, lut_sat), cv2.LUT(val, lut_val))).astype(dtype)</span><br><span class="line">   cv2.cvtColor(img_hsv, cv2.COLOR_HSV2BGR, dst=img)  <span class="comment"># no return needed</span></span><br></pre></td></tr></table></figure><h3 id="å››ã€cutout"><a href="#å››ã€cutout" class="headerlink" title="å››ã€cutout"></a>å››ã€cutout</h3><p>å¯¹æ ·æœ¬çš„éšæœºåŒºåŸŸè¿›è¡Œæ“¦é™¤ï¼Œå¹¶å¡«å……0åƒç´ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cutout</span>(<span class="params">image, labels</span>):</span></span><br><span class="line">    <span class="comment"># Applies image cutout augmentation https://arxiv.org/abs/1708.04552</span></span><br><span class="line">    h, w = image.shape[:<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">bbox_ioa</span>(<span class="params">box1, box2</span>):</span></span><br><span class="line">        <span class="comment"># Returns the intersection over box2 area given box1, box2. box1 is 4, box2 is nx4. boxes are x1y1x2y2</span></span><br><span class="line">        box2 = box2.transpose()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Get the coordinates of bounding boxes</span></span><br><span class="line">        b1_x1, b1_y1, b1_x2, b1_y2 = box1[<span class="number">0</span>], box1[<span class="number">1</span>], box1[<span class="number">2</span>], box1[<span class="number">3</span>]</span><br><span class="line">        b2_x1, b2_y1, b2_x2, b2_y2 = box2[<span class="number">0</span>], box2[<span class="number">1</span>], box2[<span class="number">2</span>], box2[<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Intersection area</span></span><br><span class="line">        inter_area = (np.minimum(b1_x2, b2_x2) - np.maximum(b1_x1, b2_x1)).clip(<span class="number">0</span>) * \</span><br><span class="line">                     (np.minimum(b1_y2, b2_y2) - np.maximum(b1_y1, b2_y1)).clip(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># box2 area</span></span><br><span class="line">        box2_area = (b2_x2 - b2_x1) * (b2_y2 - b2_y1) + <span class="number">1e-16</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Intersection over box2 area</span></span><br><span class="line">        <span class="keyword">return</span> inter_area / box2_area</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create random masks</span></span><br><span class="line">    scales = [<span class="number">0.5</span>] * <span class="number">1</span> + [<span class="number">0.25</span>] * <span class="number">2</span> + [<span class="number">0.125</span>] * <span class="number">4</span> + [<span class="number">0.0625</span>] * <span class="number">8</span> + [<span class="number">0.03125</span>] * <span class="number">16</span>  <span class="comment"># image size fraction</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> scales:</span><br><span class="line">        mask_h = random.randint(<span class="number">1</span>, <span class="built_in">int</span>(h * s))</span><br><span class="line">        mask_w = random.randint(<span class="number">1</span>, <span class="built_in">int</span>(w * s))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># box</span></span><br><span class="line">        xmin = <span class="built_in">max</span>(<span class="number">0</span>, random.randint(<span class="number">0</span>, w) - mask_w // <span class="number">2</span>)</span><br><span class="line">        ymin = <span class="built_in">max</span>(<span class="number">0</span>, random.randint(<span class="number">0</span>, h) - mask_h // <span class="number">2</span>)</span><br><span class="line">        xmax = <span class="built_in">min</span>(w, xmin + mask_w)</span><br><span class="line">        ymax = <span class="built_in">min</span>(h, ymin + mask_h)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># apply random color mask</span></span><br><span class="line">        image[ymin:ymax, xmin:xmax] = [random.randint(<span class="number">64</span>, <span class="number">191</span>) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># return unobscured labels</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(labels) <span class="keyword">and</span> s &gt; <span class="number">0.03</span>:</span><br><span class="line">            box = np.array([xmin, ymin, xmax, ymax], dtype=np.float32)</span><br><span class="line">            ioa = bbox_ioa(box, labels[:, <span class="number">1</span>:<span class="number">5</span>])  <span class="comment"># intersection over area</span></span><br><span class="line">            labels = labels[ioa &lt; <span class="number">0.60</span>]  <span class="comment"># remove &gt;60% obscured labels</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> labels</span><br></pre></td></tr></table></figure><h3 id="äº”ã€éšæœºæ°´å¹³ç¿»è½¬å’Œå‚ç›´ç¿»è½¬"><a href="#äº”ã€éšæœºæ°´å¹³ç¿»è½¬å’Œå‚ç›´ç¿»è½¬" class="headerlink" title="äº”ã€éšæœºæ°´å¹³ç¿»è½¬å’Œå‚ç›´ç¿»è½¬"></a>äº”ã€éšæœºæ°´å¹³ç¿»è½¬å’Œå‚ç›´ç¿»è½¬</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.augment:</span><br><span class="line">    <span class="comment"># flip up-down</span></span><br><span class="line">    <span class="keyword">if</span> random.random() &lt; hyp[<span class="string">&#x27;flipud&#x27;</span>]:</span><br><span class="line">        img = np.flipud(img)</span><br><span class="line">        <span class="keyword">if</span> nL:</span><br><span class="line">            labels[:, <span class="number">2</span>] = <span class="number">1</span> - labels[:, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># flip left-right</span></span><br><span class="line">    <span class="keyword">if</span> random.random() &lt; hyp[<span class="string">&#x27;fliplr&#x27;</span>]:</span><br><span class="line">        img = np.fliplr(img)</span><br><span class="line">        <span class="keyword">if</span> nL:</span><br><span class="line">            labels[:, <span class="number">1</span>] = <span class="number">1</span> - labels[:, <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">labels_out = torch.zeros((nL, <span class="number">6</span>))     </span><br></pre></td></tr></table></figure><h3 id="å…­ã€éšæœºä»¿å°„å˜æ¢"><a href="#å…­ã€éšæœºä»¿å°„å˜æ¢" class="headerlink" title="å…­ã€éšæœºä»¿å°„å˜æ¢"></a>å…­ã€éšæœºä»¿å°„å˜æ¢</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">random_perspective</span>(<span class="params">img, targets=(<span class="params"></span>), degrees=<span class="number">10</span>, translate=<span class="number">.1</span>, scale=<span class="number">.1</span>, shear=<span class="number">10</span>, perspective=<span class="number">0.0</span>, border=(<span class="params"><span class="number">0</span>, <span class="number">0</span></span>)</span>):</span></span><br><span class="line">    <span class="comment"># torchvision.transforms.RandomAffine(degrees=(-10, 10), translate=(.1, .1), scale=(.9, 1.1), shear=(-10, 10))</span></span><br><span class="line">    <span class="comment"># targets = [cls, xyxy]</span></span><br><span class="line"></span><br><span class="line">    height = img.shape[<span class="number">0</span>] + border[<span class="number">0</span>] * <span class="number">2</span>  <span class="comment"># shape(h,w,c)</span></span><br><span class="line">    width = img.shape[<span class="number">1</span>] + border[<span class="number">1</span>] * <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Center</span></span><br><span class="line">    C = np.eye(<span class="number">3</span>)</span><br><span class="line">    C[<span class="number">0</span>, <span class="number">2</span>] = -img.shape[<span class="number">1</span>] / <span class="number">2</span>  <span class="comment"># x translation (pixels)</span></span><br><span class="line">    C[<span class="number">1</span>, <span class="number">2</span>] = -img.shape[<span class="number">0</span>] / <span class="number">2</span>  <span class="comment"># y translation (pixels)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Perspective</span></span><br><span class="line">    P = np.eye(<span class="number">3</span>)</span><br><span class="line">    P[<span class="number">2</span>, <span class="number">0</span>] = random.uniform(-perspective, perspective)  <span class="comment"># x perspective (about y)</span></span><br><span class="line">    P[<span class="number">2</span>, <span class="number">1</span>] = random.uniform(-perspective, perspective)  <span class="comment"># y perspective (about x)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Rotation and Scale</span></span><br><span class="line">    R = np.eye(<span class="number">3</span>)</span><br><span class="line">    a = random.uniform(-degrees, degrees)</span><br><span class="line">    <span class="comment"># a += random.choice([-180, -90, 0, 90])  # add 90deg rotations to small rotations</span></span><br><span class="line">    s = random.uniform(<span class="number">1</span> - scale, <span class="number">1</span> + scale)</span><br><span class="line">    <span class="comment"># s = 2 ** random.uniform(-scale, scale)</span></span><br><span class="line">    R[:<span class="number">2</span>] = cv2.getRotationMatrix2D(angle=a, center=(<span class="number">0</span>, <span class="number">0</span>), scale=s)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Shear</span></span><br><span class="line">    S = np.eye(<span class="number">3</span>)</span><br><span class="line">    S[<span class="number">0</span>, <span class="number">1</span>] = math.tan(random.uniform(-shear, shear) * math.pi / <span class="number">180</span>)  <span class="comment"># x shear (deg)</span></span><br><span class="line">    S[<span class="number">1</span>, <span class="number">0</span>] = math.tan(random.uniform(-shear, shear) * math.pi / <span class="number">180</span>)  <span class="comment"># y shear (deg)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Translation</span></span><br><span class="line">    T = np.eye(<span class="number">3</span>)</span><br><span class="line">    T[<span class="number">0</span>, <span class="number">2</span>] = random.uniform(<span class="number">0.5</span> - translate, <span class="number">0.5</span> + translate) * width  <span class="comment"># x translation (pixels)</span></span><br><span class="line">    T[<span class="number">1</span>, <span class="number">2</span>] = random.uniform(<span class="number">0.5</span> - translate, <span class="number">0.5</span> + translate) * height  <span class="comment"># y translation (pixels)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Combined rotation matrix</span></span><br><span class="line">    M = T @ S @ R @ P @ C  <span class="comment"># order of operations (right to left) is IMPORTANT</span></span><br><span class="line">    <span class="keyword">if</span> (border[<span class="number">0</span>] != <span class="number">0</span>) <span class="keyword">or</span> (border[<span class="number">1</span>] != <span class="number">0</span>) <span class="keyword">or</span> (M != np.eye(<span class="number">3</span>)).<span class="built_in">any</span>():  <span class="comment"># image changed</span></span><br><span class="line">        <span class="keyword">if</span> perspective:</span><br><span class="line">            img = cv2.warpPerspective(img, M, dsize=(width, height), borderValue=(<span class="number">114</span>, <span class="number">114</span>, <span class="number">114</span>))</span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># affine</span></span><br><span class="line">            img = cv2.warpAffine(img, M[:<span class="number">2</span>], dsize=(width, height), borderValue=(<span class="number">114</span>, <span class="number">114</span>, <span class="number">114</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Visualize</span></span><br><span class="line">    <span class="comment"># import matplotlib.pyplot as plt</span></span><br><span class="line">    <span class="comment"># ax = plt.subplots(1, 2, figsize=(12, 6))[1].ravel()</span></span><br><span class="line">    <span class="comment"># ax[0].imshow(img[:, :, ::-1])  # base</span></span><br><span class="line">    <span class="comment"># ax[1].imshow(img2[:, :, ::-1])  # warped</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Transform labels coordinates</span></span><br><span class="line">    n = <span class="built_in">len</span>(targets)</span><br><span class="line">    <span class="keyword">if</span> n:</span><br><span class="line">        <span class="comment"># warp points</span></span><br><span class="line">        xy = np.ones((n * <span class="number">4</span>, <span class="number">3</span>))</span><br><span class="line">        xy[:, :<span class="number">2</span>] = targets[:, [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>]].reshape(n * <span class="number">4</span>, <span class="number">2</span>)  <span class="comment"># x1y1, x2y2, x1y2, x2y1</span></span><br><span class="line">        xy = xy @ M.T  <span class="comment"># transform</span></span><br><span class="line">        <span class="keyword">if</span> perspective:</span><br><span class="line">            xy = (xy[:, :<span class="number">2</span>] / xy[:, <span class="number">2</span>:<span class="number">3</span>]).reshape(n, <span class="number">8</span>)  <span class="comment"># rescale</span></span><br><span class="line">        <span class="keyword">else</span>:  <span class="comment"># affine</span></span><br><span class="line">            xy = xy[:, :<span class="number">2</span>].reshape(n, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create new boxes</span></span><br><span class="line">        x = xy[:, [<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>]]</span><br><span class="line">        y = xy[:, [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>]]</span><br><span class="line">        xy = np.concatenate((x.<span class="built_in">min</span>(<span class="number">1</span>), y.<span class="built_in">min</span>(<span class="number">1</span>), x.<span class="built_in">max</span>(<span class="number">1</span>), y.<span class="built_in">max</span>(<span class="number">1</span>))).reshape(<span class="number">4</span>, n).T</span><br><span class="line"></span><br><span class="line">        <span class="comment"># # apply angle-based reduction of bounding boxes</span></span><br><span class="line">        <span class="comment"># radians = a * math.pi / 180</span></span><br><span class="line">        <span class="comment"># reduction = max(abs(math.sin(radians)), abs(math.cos(radians))) ** 0.5</span></span><br><span class="line">        <span class="comment"># x = (xy[:, 2] + xy[:, 0]) / 2</span></span><br><span class="line">        <span class="comment"># y = (xy[:, 3] + xy[:, 1]) / 2</span></span><br><span class="line">        <span class="comment"># w = (xy[:, 2] - xy[:, 0]) * reduction</span></span><br><span class="line">        <span class="comment"># h = (xy[:, 3] - xy[:, 1]) * reduction</span></span><br><span class="line">        <span class="comment"># xy = np.concatenate((x - w / 2, y - h / 2, x + w / 2, y + h / 2)).reshape(4, n).T</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># clip boxes</span></span><br><span class="line">        xy[:, [<span class="number">0</span>, <span class="number">2</span>]] = xy[:, [<span class="number">0</span>, <span class="number">2</span>]].clip(<span class="number">0</span>, width)</span><br><span class="line">        xy[:, [<span class="number">1</span>, <span class="number">3</span>]] = xy[:, [<span class="number">1</span>, <span class="number">3</span>]].clip(<span class="number">0</span>, height)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># filter candidates</span></span><br><span class="line">        i = box_candidates(box1=targets[:, <span class="number">1</span>:<span class="number">5</span>].T * s, box2=xy.T)</span><br><span class="line">        targets = targets[i]</span><br><span class="line">        targets[:, <span class="number">1</span>:<span class="number">5</span>] = xy[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img, targets</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a href="https://zhuanlan.zhihu.com/p/93822508">https://zhuanlan.zhihu.com/p/93822508</a></p>]]></content>
      
      
      <categories>
          
          <category> Computer Vision </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Computer Vision </tag>
            
            <tag> Deep Learning </tag>
            
            <tag> Data Augmentation </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ã€ç›®æ ‡æ£€æµ‹ç³»åˆ—ã€‘Faster-RCNNç½‘ç»œç»“æ„è§£è¯»ä¸ä»£ç åˆ†æ</title>
      <link href="2021/02/14/cv/faster-rcnn/"/>
      <url>2021/02/14/cv/faster-rcnn/</url>
      
        <content type="html"><![CDATA[<h1 id="ã€ç›®æ ‡æ£€æµ‹ç³»åˆ—ã€‘Faster-RCNNç½‘ç»œç»“æ„è§£è¯»ä¸ä»£ç åˆ†æ"><a href="#ã€ç›®æ ‡æ£€æµ‹ç³»åˆ—ã€‘Faster-RCNNç½‘ç»œç»“æ„è§£è¯»ä¸ä»£ç åˆ†æ" class="headerlink" title="ã€ç›®æ ‡æ£€æµ‹ç³»åˆ—ã€‘Faster-RCNNç½‘ç»œç»“æ„è§£è¯»ä¸ä»£ç åˆ†æ"></a>ã€ç›®æ ‡æ£€æµ‹ç³»åˆ—ã€‘Faster-RCNNç½‘ç»œç»“æ„è§£è¯»ä¸ä»£ç åˆ†æ</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ç»è¿‡R-CNNå’ŒFast RCNNçš„ç§¯æ·€ï¼Œç”±ä½•å‡¯æ˜å¤§ç¥æå‡ºçš„Faster-RCNNï¼Œå°†ç‰¹å¾æå–ï¼ˆfeature extractionï¼‰ï¼Œå€™é€‰æ¡†æå–ï¼ˆæ›¿ä»£äº†R-CNNä¸Fast RCNNä¸­æ¯”è¾ƒè€—æ—¶çš„<strong>Selective Search</strong>ï¼‰ï¼Œbboxå›å½’å’Œåˆ†ç±»éƒ½æ•´åˆåˆ°ä¸€ä¸ªç½‘ç»œä¸­ã€‚æ¨ç†ç¬¬ä¸€é˜¶æ®µå…ˆæ‰¾å‡ºå›¾ç‰‡ä¸­å¾…æ£€æµ‹ç‰©ä½“çš„anchorçŸ©å½¢æ¡†ï¼ˆå¯¹èƒŒæ™¯ã€å¾…æ£€æµ‹ç‰©ä½“è¿›è¡ŒäºŒåˆ†ç±»ï¼‰ï¼Œç¬¬äºŒé˜¶æ®µå¯¹anchoræ¡†å†…å¾…æ£€æµ‹ç‰©ä½“è¿›è¡Œåˆ†ç±»ã€‚æå¤§çš„æå‡äº†æ£€æµ‹çš„é€Ÿåº¦å’Œç²¾åº¦ã€‚æœ¬æ–‡å°†å¯¹<strong>Faster-RCNN</strong>çš„ç½‘ç»œç»“æ„è¿›è¡Œè§£è¯»å¹¶ç»“åˆ<a href="https://github.com/jwyang/faster-rcnn.pytorch">ä»£ç </a>è¿›è¡Œåˆ†æã€‚</p><h2 id="è¯¦è§£"><a href="#è¯¦è§£" class="headerlink" title="è¯¦è§£"></a>è¯¦è§£</h2><h3 id="æ•´ä½“ç»“æ„å›¾ï¼š"><a href="#æ•´ä½“ç»“æ„å›¾ï¼š" class="headerlink" title="æ•´ä½“ç»“æ„å›¾ï¼š"></a>æ•´ä½“ç»“æ„å›¾ï¼š</h3><p><img src="/2021/02/14/cv/faster-rcnn/v2-c0172be282021a1029f7b72b51079ffe_720w.jpg" alt="img"></p><h3 id="ç‰¹å¾æå–ç½‘ç»œï¼ˆBackbone"><a href="#ç‰¹å¾æå–ç½‘ç»œï¼ˆBackbone" class="headerlink" title="ç‰¹å¾æå–ç½‘ç»œï¼ˆBackbone)"></a>ç‰¹å¾æå–ç½‘ç»œï¼ˆBackbone)</h3><p>â€‹    Backboneåˆç§°éª¨å¹²ç½‘ç»œï¼Œç”¨äºå…±äº«å·ç§¯åŸºç¡€å±‚ï¼Œæå–ç‰¹å¾ï¼ˆfeature mapï¼‰ï¼Œç»™åé¢çš„RPNå’Œå…¨è¿æ¥å±‚ä½¿ç”¨ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„Backboneæœ‰ResNetç³»åˆ—ï¼ŒEfficientNetç³»åˆ—ï¼Œå¦‚æœå¯¹ç²¾åº¦çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥è€ƒè™‘è¿™ä¸¤ç±»ç½‘ç»œï¼Œå¦‚æœæ˜¯ç§»åŠ¨ç«¯å¯¹é€Ÿåº¦çš„è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯ä»¥ä½¿ç”¨shuffleNetç³»åˆ—ï¼ŒmobileNetç³»åˆ—ï¼Œè¿˜æœ‰æœ€è¿‘æ–°å‡ºçš„<a href="https://github.com/DingXiaoH/RepVGG">RepVGG</a>ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p>â€‹    è€Œæœ¬æ–‡ä»£ç ä¸­ä½¿ç”¨çš„æ˜¯vgg16ä½œä¸ºbackboneï¼Œç”±äºç¯‡å¹…çš„åŸå› ï¼Œä¸”ä¸åŒçš„backboneçš„å¤„ç†æ–¹å¼ä¼šæœ‰ç»†å¾®çš„å·®åˆ«ï¼Œå› æ­¤æœ¬æ–‡å¯¹äºvgg16çš„ç»†èŠ‚ä¸è¿›è¡Œå±•å¼€ï¼Œåç»­ä¼šæœ‰ä¸“é—¨çš„ç« èŠ‚ä»‹ç»backbone(æŒ–å‘)</p><h4 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_init_modules</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">import</span> torchvision.models <span class="keyword">as</span> models</span><br><span class="line">    vgg = models.vgg16()</span><br><span class="line">   <span class="keyword">if</span> self.pretrained:</span><br><span class="line">        print(<span class="string">&quot;Loading pretrained weights from %s&quot;</span> %(self.model_path))</span><br><span class="line">        state_dict = torch.load(self.model_path)</span><br><span class="line">        vgg.load_state_dict(&#123;k:v <span class="keyword">for</span> k,v <span class="keyword">in</span> state_dict.items() <span class="keyword">if</span> k <span class="keyword">in</span> vgg.state_dict()&#125;)</span><br><span class="line"></span><br><span class="line">    vgg.classifier = nn.Sequential(*<span class="built_in">list</span>(vgg.classifier._modules.values())[:-<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># not using the last maxpool layer</span></span><br><span class="line">    self.RCNN_base = nn.Sequential(*<span class="built_in">list</span>(vgg.features._modules.values())[:-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>â€‹    ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½œè€…ä½¿ç”¨çš„æ˜¯torchvisionè‡ªå¸¦çš„modelsï¼Œå»æ‰äº†vgg16çš„æœ€åä¸€å±‚æ± åŒ–å±‚ï¼Œä¹Ÿå°±æ˜¯å»æ‰äº†é™é‡‡æ ·ï¼Œæˆ‘æƒ³åŸå› åº”è¯¥æ˜¯æƒ³æå–æ›´å¤šçš„å°å°ºåº¦ç‰¹å¾å§ğŸ˜„</p><h3 id="åŒºåŸŸæè®®ç½‘ç»œï¼ˆRegion-Proposal-Networkï¼‰"><a href="#åŒºåŸŸæè®®ç½‘ç»œï¼ˆRegion-Proposal-Networkï¼‰" class="headerlink" title="åŒºåŸŸæè®®ç½‘ç»œï¼ˆRegion Proposal Networkï¼‰"></a>åŒºåŸŸæè®®ç½‘ç»œï¼ˆRegion Proposal Networkï¼‰</h3><h4 id="ç½‘ç»œç»“æ„å›¾ï¼š"><a href="#ç½‘ç»œç»“æ„å›¾ï¼š" class="headerlink" title="ç½‘ç»œç»“æ„å›¾ï¼š"></a>ç½‘ç»œç»“æ„å›¾ï¼š</h4><p><img src="/2021/02/14/cv/faster-rcnn/v2-1908feeaba591d28bee3c4a754cca282_720w.jpg" alt="img"></p><p>â€‹    RPNå¯ä»¥è¯´æ˜¯Faster-RCNNçš„çµé­‚æ‰€åœ¨ï¼Œä¼ ç»Ÿçš„<strong>Selective Search</strong>è¯´ç™½äº†å°±æ˜¯ç©·ä¸¾ï¼Œç„¶åå¯¹æ¯ä¸ªåŒºåŸŸè¿›è¡Œæ‰“åˆ†ï¼Œå¾—åˆ°ä¸ground truthæœ€æ¥è¿‘çš„ç›®æ ‡ï¼Œç›¸å½“è€—æ—¶ã€‚è€ŒRPNçš„ç²¾å¦™ä¹‹å¤„å°±åœ¨äºä»–å‡­å€Ÿanchorç”Ÿæˆå€™é€‰æ¡†ï¼Œæ¥ç€é€šè¿‡softmaxåŒºåˆ«æ­£è´Ÿanchor, ç„¶åå¯¹æ­£æ ·æœ¬è¿›è¡Œ<strong>è¾¹ç•Œæ¡†å›å½’ï¼ˆBounding Box Regressionï¼‰</strong>ä»¥ä¿®æ­£anchorå¾—åˆ°ç²¾å‡†çš„æè®®æ¡†ï¼ˆproposalï¼‰åé¢ç”¨äºå¯¹æè®®æ¡†è¿›è¡Œç›®æ ‡åˆ†ç±»ã€‚</p><p>ï¼ˆçœ‹å®Œä¸€é•¿ä¸²æ¦‚å¿µï¼Œè„‘å­é‡Œå¿…å®šæ˜¯ä¸€å †é—®å·ï¼Œä»€ä¹ˆæ˜¯anchorï¼Ÿå®ƒé•¿å•¥æ ·ï¼Ÿå®ƒæ˜¯æ€ä¹ˆç”Ÿæˆçš„ï¼Ÿä»€ä¹ˆæ˜¯è¾¹ç•Œæ¡†å›å½’ï¼Ÿï¼Ÿï¼Ÿæ­¤æ—¶å¿ƒä¸­ä¸€ä¸‡åªç¾Šé©¼è·¯è¿‡ã€‚æˆ‘è¯´åœåœï¼Œè¿™å°±ç»™ä½ è§£é‡ŠğŸ˜ï¼‰</p><h4 id="Anchor"><a href="#Anchor" class="headerlink" title="Anchor"></a>Anchor</h4><p>â€‹    å…¶å®anchorè·Ÿselective searchçš„ä½œç”¨æ˜¯å·®ä¸å¤šçš„ï¼Œä¹Ÿæ˜¯ä¸ºäº†å¾—åˆ°ä¸€å †å¯èƒ½åŒ…å«å¾…æ£€æµ‹ç›®æ ‡çš„bounding boxã€‚å®ƒå…·ä½“ä½œæ³•æ˜¯æŠŠæ¯ä¸ªç‰¹å¾ç‚¹æ˜ å°„å›åŸå›¾çš„æ„Ÿå—é‡çš„ä¸­å¿ƒç‚¹å½“æˆä¸€ä¸ªåŸºå‡†ç‚¹ï¼Œè¿™é‡Œé¢å°ä¼™ä¼´ä»¬è‚¯å®šä¼šæœ‰ç–‘æƒ‘ï¼Œç‰¹å¾ç‚¹è¯¥æ€ä¹ˆæ˜ å°„å›åŸå›¾å‘¢ï¼Ÿï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç¡®ï¼Œç‰¹å¾å›¾æ˜¯åŸå›¾ç»è¿‡å·ç§¯æ“ä½œåå¾—åˆ°çš„ï¼Œè€Œå·ç§¯å°±æ˜¯å·ç§¯æ ¸åœ¨å›¾ç‰‡çŸ©é˜µä¸Šè¿›è¡Œæ»‘åŠ¨çª—å£å¼éå†æ“ä½œï¼ŒåŸå›¾å—å·ç§¯æ ¸å½±å“çš„åŒºåŸŸè¢«ç§°ä¸ºæ„Ÿå—é‡ï¼Œå¦‚æœæˆ‘ä»¬æœ€åå¾—åˆ°çš„ç‰¹å¾å›¾å¼60*60çš„ï¼Œé‚£ä¹ˆåœ¨åŸå›¾ä¸Šä¹Ÿå°±å¯¹åº”äº†60ä¸ªæ„Ÿå—é‡ï¼Œæˆ‘ä»¬å°†æ„Ÿå—é‡çš„ä¸­å¿ƒä½œä¸ºanchorçš„åŸºå‡†ç‚¹ï¼Œæˆ‘ä»¬å‡è®¾ç¬¬ä¸€ä¸ªæ„Ÿå—é‡çš„ä¸­å¿ƒæ˜¯ï¼ˆ0ï¼Œ0ï¼‰ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªåŸºå‡†ç‚¹ï¼Œæ¥ä¸‹å»çš„åŸºå‡†ç‚¹éƒ½ä¸å‰ä¸€ä¸ªåŸºå‡†ç‚¹ç›¸éš”base_sizeä¸ªç‚¹ï¼ˆbase_sizeæŒ‡æ„Ÿå—é‡å¤§å°ï¼‰ï¼Œæ˜¾ç„¶æœ€åæˆ‘ä»¬ç”Ÿæˆäº†60ä¸ªåŸºå‡†ç‚¹ï¼Œç„¶åå›´ç»•è¿™60ä¸ªåŸºå‡†ç‚¹é€‰å–kä¸ªä¸åŒscaleã€aspect ratioçš„anchorã€‚è®ºæ–‡ä¸­3ä¸ªscaleï¼ˆä¸‰ç§é¢ç§¯{128^2ï¼Œ256^2ï¼Œ512^2}ï¼‰ï¼Œ3ä¸ªaspect ratio( ä¸‰ç§é•¿å®½æ¯”{1:1ï¼Œ1:2ï¼Œ2:1} )ï¼Œä¸‹å›¾æ˜¯ä»¥ä¸€ä¸ªåŸºå‡†ç‚¹ç”Ÿæˆçš„kï¼ˆk=9ï¼‰ä¸ªanchorï¼Œé‚£ä¹ˆå‰©ä¸‹çš„åŸºå‡†ç‚¹ä»¥æ­¤ç±»æ¨ã€‚</p><p><img src="/2021/02/14/cv/faster-rcnn/v2-9962c78b9963fc323ba04ffb80f0cd95_720w.png" alt="img"></p><h5 id="ä»£ç -1"><a href="#ä»£ç -1" class="headerlink" title="ä»£ç "></a>ä»£ç </h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">enumerate_shifted_anchor</span>(<span class="params">base_anchor, base_size, width, height</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    function description: å‡å°‘ä¸å¿…è¦çš„å¦‚generate_base_anchorsçš„è®¡ç®—, è¾ƒå¤§çš„ç‰¹å¾å›¾çš„é”šæ¡†ç”Ÿæˆæ¨¡æ¿, ç”Ÿæˆé”šæ¡†çš„åˆé€‰æ¨¡æ¿å³æ»‘åŠ¨çª—å£</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    :param base_anchor: éœ€è¦reshapeçš„anchors</span></span><br><span class="line"><span class="string">    :param base_size: ç‰¹å¾å›¾çš„æ¯ä¸ªåƒç´ çš„æ„Ÿå—é‡å¤§å°</span></span><br><span class="line"><span class="string">    :param height: featuremapçš„é«˜åº¦</span></span><br><span class="line"><span class="string">    :param width: featuremapçš„å®½åº¦</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">        anchor: ç»´åº¦ä¸º:[width*height*k, 4]çš„å…ˆéªŒæ¡†(anchors)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># è®¡ç®—featuremapä¸­æ¯ä¸ªåƒç´ ç‚¹åœ¨åŸå›¾ä¸­æ„Ÿå—é‡ä¸Šçš„ä¸­å¿ƒç‚¹åæ ‡</span></span><br><span class="line">    shift_x = np.arange(<span class="number">0</span>, width * base_size, base_size)</span><br><span class="line">    shift_y = np.arange(<span class="number">0</span>, height * base_size, base_size)</span><br><span class="line">    shift_x, shift_y = np.meshgrid(shift_x, shift_y)</span><br><span class="line">    print(<span class="string">&#x27;shift_x: &#x27;</span>, shift_x.shape, <span class="string">&#x27;shift_y: &#x27;</span>, shift_y.shape)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO æ„Ÿè§‰æœ€æ­£ç»Ÿçš„æ–¹æ³•è¿˜æ˜¯éå†ä¸­å¿ƒç‚¹</span></span><br><span class="line">    <span class="comment"># index = 0</span></span><br><span class="line">    <span class="comment"># for x in shift_x:</span></span><br><span class="line">    <span class="comment">#     for y in shift_y:</span></span><br><span class="line">    <span class="comment">#         anchors = generate_base_anchors(center_x=x, center_y=y)</span></span><br><span class="line">    <span class="comment">#         if index == 0:</span></span><br><span class="line">    <span class="comment">#             old_anchors = anchors</span></span><br><span class="line">    <span class="comment">#         else:</span></span><br><span class="line">    <span class="comment">#             anchors = np.concatenate((old_anchors, anchors), axis=0)</span></span><br><span class="line">    <span class="comment">#             old_anchors = anchors</span></span><br><span class="line">    <span class="comment">#         index += 1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># TODO ç›´æ¥åˆ©ç”¨broadcastè²Œä¼¼ä¹Ÿå¯ä»¥è¾¾åˆ°ç›®çš„</span></span><br><span class="line">    <span class="comment"># shift_x.ravel()è¡¨ç¤ºåŸåœ°å°†ä¸ºä¸€ç»´æ•°ç»„, shiftçš„ç»´åº¦ä¸º: [feature_stride, 4]</span></span><br><span class="line">    shift = np.stack((shift_x.ravel(), shift_y.ravel(), shift_x.ravel(), shift_y.ravel(),), axis=<span class="number">1</span>)</span><br><span class="line">    A = base_anchor.shape[<span class="number">0</span>]</span><br><span class="line">    K = shift.shape[<span class="number">0</span>]</span><br><span class="line">    anchor = base_anchor.reshape((<span class="number">1</span>, A, <span class="number">4</span>)) + shift.reshape((K, <span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># æœ€åå†åˆæˆä¸ºæ‰€æœ‰çš„å…ˆéªŒæ¡†, ç›¸å½“äºå¯¹featuremapçš„æ¯ä¸ªåƒç´ ç‚¹éƒ½ç”Ÿæˆk(9)ä¸ªå…ˆéªŒæ¡†(anchors)</span></span><br><span class="line">    anchors = anchor.reshape((K * A, <span class="number">4</span>)).astype(np.float32)</span><br><span class="line">    print(<span class="string">&#x27;result: &#x27;</span>, anchors.shape)</span><br><span class="line">    <span class="keyword">return</span> anchors</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬éœ€è¦æ±‚å‡ºæ„Ÿå—ç‚¹ä¸­å¿ƒå¯¹åº”åœ¨åŸå›¾ä¸­çš„åæ ‡</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shift_x = np.arange(<span class="number">0</span>, width * base_size, base_size)</span><br><span class="line">shift_y = np.arange(<span class="number">0</span>, height * base_size, base_size)</span><br><span class="line">shift_x, shift_y = np.meshgrid(shift_x, shift_y)</span><br></pre></td></tr></table></figure><p>æ¥ç€æˆ‘ä»¬ç”Ÿæˆanchors</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shift = np.stack((shift_x.ravel(), shift_y.ravel(), shift_x.ravel(), shift_y.ravel(),), axis=<span class="number">1</span>)</span><br><span class="line">A = base_anchor.shape[<span class="number">0</span>]</span><br><span class="line">K = shift.shape[<span class="number">0</span>]</span><br><span class="line">anchor = base_anchor.reshape((<span class="number">1</span>, A, <span class="number">4</span>)) + shift.reshape((K, <span class="number">1</span>, <span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€åå†åˆæˆä¸ºæ‰€æœ‰çš„å…ˆéªŒæ¡†, ç›¸å½“äºå¯¹featuremapçš„æ¯ä¸ªåƒç´ ç‚¹éƒ½ç”Ÿæˆk(9)ä¸ªå…ˆéªŒæ¡†(anchors)</span></span><br><span class="line">anchors = anchor.reshape((K * A, <span class="number">4</span>)).astype(np.float32)</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆbase_anchorï¼ˆä»¥ï¼ˆ0,0ï¼‰ä¸ºåŸºå‡†ç‚¹çš„ç¬¬ä¸€ç»„anchorï¼‰æ˜¯æ€ä¹ˆæ¥çš„å‘¢</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># Verify that we compute the same anchors as Shaoqing&#x27;s matlab implementation:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    &gt;&gt; load output/rpn_cachedir/faster_rcnn_VOC2007_ZF_stage1_rpn/anchors.mat</span></span><br><span class="line"><span class="comment">#    &gt;&gt; anchors</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    anchors =</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       -83   -39   100    56</span></span><br><span class="line"><span class="comment">#      -175   -87   192   104</span></span><br><span class="line"><span class="comment">#      -359  -183   376   200</span></span><br><span class="line"><span class="comment">#       -55   -55    72    72</span></span><br><span class="line"><span class="comment">#      -119  -119   136   136</span></span><br><span class="line"><span class="comment">#      -247  -247   264   264</span></span><br><span class="line"><span class="comment">#       -35   -79    52    96</span></span><br><span class="line"><span class="comment">#       -79  -167    96   184</span></span><br><span class="line"><span class="comment">#      -167  -343   184   360</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#array([[ -83.,  -39.,  100.,   56.],</span></span><br><span class="line"><span class="comment">#       [-175.,  -87.,  192.,  104.],</span></span><br><span class="line"><span class="comment">#       [-359., -183.,  376.,  200.],</span></span><br><span class="line"><span class="comment">#       [ -55.,  -55.,   72.,   72.],</span></span><br><span class="line"><span class="comment">#       [-119., -119.,  136.,  136.],</span></span><br><span class="line"><span class="comment">#       [-247., -247.,  264.,  264.],</span></span><br><span class="line"><span class="comment">#       [ -35.,  -79.,   52.,   96.],</span></span><br><span class="line"><span class="comment">#       [ -79., -167.,   96.,  184.],</span></span><br><span class="line"><span class="comment">#       [-167., -343.,  184.,  360.]])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    xrange          <span class="comment"># Python 2</span></span><br><span class="line"><span class="keyword">except</span> NameError:</span><br><span class="line">    xrange = <span class="built_in">range</span>  <span class="comment"># Python 3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_anchors</span>(<span class="params">base_size=<span class="number">16</span>, ratios=[<span class="number">0.5</span>, <span class="number">1</span>, <span class="number">2</span>],</span></span></span><br><span class="line"><span class="function"><span class="params">                     scales=<span class="number">2</span>**np.arange(<span class="params"><span class="number">3</span>, <span class="number">6</span></span>)</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Generate anchor (reference) windows by enumerating aspect ratios X</span></span><br><span class="line"><span class="string">    scales wrt a reference (0, 0, 15, 15) window.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    base_anchor = np.array([<span class="number">1</span>, <span class="number">1</span>, base_size, base_size]) - <span class="number">1</span></span><br><span class="line">    ratio_anchors = _ratio_enum(base_anchor, ratios)</span><br><span class="line">    print(<span class="string">f&#x27;ratio_anchors : <span class="subst">&#123;ratio_anchors&#125;</span>&#x27;</span>)</span><br><span class="line">    anchors = np.vstack([_scale_enum(ratio_anchors[i, :], scales)</span><br><span class="line">                         <span class="keyword">for</span> i <span class="keyword">in</span> xrange(ratio_anchors.shape[<span class="number">0</span>])])</span><br><span class="line">    <span class="keyword">return</span> anchors</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_whctrs</span>(<span class="params">anchor</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Return width, height, x center, and y center for an anchor (window).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    w = anchor[<span class="number">2</span>] - anchor[<span class="number">0</span>] + <span class="number">1</span></span><br><span class="line">    h = anchor[<span class="number">3</span>] - anchor[<span class="number">1</span>] + <span class="number">1</span></span><br><span class="line">    x_ctr = anchor[<span class="number">0</span>] + <span class="number">0.5</span> * (w - <span class="number">1</span>)</span><br><span class="line">    y_ctr = anchor[<span class="number">1</span>] + <span class="number">0.5</span> * (h - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> w, h, x_ctr, y_ctr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_mkanchors</span>(<span class="params">ws, hs, x_ctr, y_ctr</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Given a vector of widths (ws) and heights (hs) around a center</span></span><br><span class="line"><span class="string">    (x_ctr, y_ctr), output a set of anchors (windows).</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    ws = ws[:, np.newaxis]</span><br><span class="line">    hs = hs[:, np.newaxis]</span><br><span class="line">    anchors = np.hstack((x_ctr - <span class="number">0.5</span> * (ws - <span class="number">1</span>),</span><br><span class="line">                         y_ctr - <span class="number">0.5</span> * (hs - <span class="number">1</span>),</span><br><span class="line">                         x_ctr + <span class="number">0.5</span> * (ws - <span class="number">1</span>),</span><br><span class="line">                         y_ctr + <span class="number">0.5</span> * (hs - <span class="number">1</span>)))</span><br><span class="line">    <span class="keyword">return</span> anchors</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ratio_enum</span>(<span class="params">anchor, ratios</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Enumerate a set of anchors for each aspect ratio wrt an anchor.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    w, h, x_ctr, y_ctr = _whctrs(anchor)</span><br><span class="line">    size = w * h</span><br><span class="line">    size_ratios = size / ratios</span><br><span class="line">    print(<span class="string">f&#x27;size_ratios : <span class="subst">&#123;size_ratios&#125;</span>&#x27;</span>)</span><br><span class="line">    ws = np.<span class="built_in">round</span>(np.sqrt(size_ratios))</span><br><span class="line">    hs = np.<span class="built_in">round</span>(ws * ratios)</span><br><span class="line">    print(<span class="string">f&#x27;ws: <span class="subst">&#123;ws&#125;</span>, hs : <span class="subst">&#123;hs&#125;</span>&#x27;</span>)</span><br><span class="line">    anchors = _mkanchors(ws, hs, x_ctr, y_ctr)</span><br><span class="line">    <span class="keyword">return</span> anchors</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_scale_enum</span>(<span class="params">anchor, scales</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Enumerate a set of anchors for each scale wrt an anchor.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    w, h, x_ctr, y_ctr = _whctrs(anchor)</span><br><span class="line">    <span class="comment"># print(f&#x27;w, h, x_ctr, y_ctr in scale enum: &#123;w, h, x_ctr, y_ctr&#125;&#x27;)</span></span><br><span class="line">    print(<span class="string">f&#x27;scales: <span class="subst">&#123;scales&#125;</span>&#x27;</span>)</span><br><span class="line">    ws = w * scales</span><br><span class="line">    hs = h * scales</span><br><span class="line">    <span class="comment"># print(f&#x27;ws, hs : &#123;ws, hs&#125;&#x27;)</span></span><br><span class="line">    anchors = _mkanchors(ws, hs, x_ctr, y_ctr)</span><br><span class="line">    print(<span class="string">f&#x27;scaled anchor: <span class="subst">&#123;anchors&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> anchors</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    t = time.time()</span><br><span class="line">    all_anchors = generate_anchors()</span><br><span class="line">    print(<span class="string">f&#x27;generated anchor: <span class="subst">&#123;all_anchors&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>â€‹    ä¸Šé¢çš„ä»£ç ä¸­ generate_anchors ä¸»è¦è´Ÿè´£ç”Ÿæˆanchorï¼Œ_whctrsè´Ÿè´£å°†åæ ‡è½¬æ¢ä¸ºï¼ˆå®½ï¼Œé«˜ï¼Œä¸­å¿ƒç‚¹xåæ ‡ï¼Œä¸­å¿ƒç‚¹yåæ ‡ï¼‰ï¼Œ_mkanchorsè´Ÿè´£å°†åæ ‡è½¬æ¢ä¸ºï¼ˆå·¦ä¸Šxï¼Œå·¦ä¸Šyï¼Œå³ä¸‹xï¼Œå³ä¸‹yï¼‰ä¹Ÿå°±æ˜¯anchorçš„åæ ‡å½¢å¼ï¼Œ_ratio_enumæ˜¯æ ¹æ®è®¾ç½®çš„ratioï¼Œç”Ÿæˆä½äºåŒä¸€ä¸­å¿ƒç‚¹é¢ç§¯ç›¸ç­‰ä½†åæ ‡ä¸åŒanchorï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„åŒè‰²çŸ©å½¢ï¼Œè€Œ_scale_enumåˆ™æ˜¯ç”Ÿæˆï¼ŒåŒæ¯”ä¾‹ï¼Œä½†æ˜¯é¢ç§¯ä¸åŒçš„kç»„anchorï¼Œå¤§å°ç”±scaleå†³å®šï¼Œé¢ç§¯ä¸ºbase_size * scale.</p><p>åˆ°è¿™é‡Œï¼Œanchorçš„ç”Ÿæˆä¹Ÿå°±ç»“æŸäº†ã€‚</p><p>å¾—åˆ°äº†å…ˆéªŒæ¡†ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆæ‰èƒ½ç­›é€‰å‡ºå«æœ‰ç›®æ ‡ç‰©ä½“çš„æ¡†å‘¢</p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç®€å•çš„ç­›é€‰ä¸€ä¸‹ï¼Œå“ªäº›æ¡†åŒ…å«ç‰©ä½“ï¼Œå“ªäº›ä¸åŒ…å«ï¼Œä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„æ–¹æ³•å°±æ˜¯è®¡ç®—bounding boxå’Œgroud truth çš„äº¤å¹¶æ¯”ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸èƒ½çœ‹åˆ°çš„ä¸€ä¸ªåè¯<strong>IOU</strong></p><h4 id="IOU"><a href="#IOU" class="headerlink" title="IOU"></a>IOU</h4><p>IOUçš„å®šä¹‰æ˜¯bounding box ä¸ground truth çš„äº¤é›†ï¼Œæ¯”ä¸Šä»–ä¿©çš„å¹¶é›†ï¼Œä¸€èˆ¬æˆ‘ä»¬è®¾å®šå½“iouå¤§äº0.7åˆ™è®¤ä¸ºbounding box åŒ…å«äº†ç›®æ ‡ï¼Œå³ä¸ºæ­£ç±»ï¼Œå½“iouå°äº0.3æ—¶æˆ‘ä»¬åˆ™è®¤ä¸ºä»–æ˜¯ä¸€ä¸ªè´Ÿç±»ï¼Œæ„æ€æ˜¯ä¸åŒ…å«ç›®æ ‡ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Iou</span>(<span class="params">box1, box2, wh=<span class="literal">False</span></span>):</span></span><br><span class="line">    <span class="keyword">if</span> wh == <span class="literal">False</span>:</span><br><span class="line">xmin1, ymin1, xmax1, ymax1 = box1</span><br><span class="line">xmin2, ymin2, xmax2, ymax2 = box2</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">xmin1, ymin1 = <span class="built_in">int</span>(box1[<span class="number">0</span>]-box1[<span class="number">2</span>]/<span class="number">2.0</span>), <span class="built_in">int</span>(box1[<span class="number">1</span>]-box1[<span class="number">3</span>]/<span class="number">2.0</span>)</span><br><span class="line">xmax1, ymax1 = <span class="built_in">int</span>(box1[<span class="number">0</span>]+box1[<span class="number">2</span>]/<span class="number">2.0</span>), <span class="built_in">int</span>(box1[<span class="number">1</span>]+box1[<span class="number">3</span>]/<span class="number">2.0</span>)</span><br><span class="line">xmin2, ymin2 = <span class="built_in">int</span>(box2[<span class="number">0</span>]-box2[<span class="number">2</span>]/<span class="number">2.0</span>), <span class="built_in">int</span>(box2[<span class="number">1</span>]-box2[<span class="number">3</span>]/<span class="number">2.0</span>)</span><br><span class="line">xmax2, ymax2 = <span class="built_in">int</span>(box2[<span class="number">0</span>]+box2[<span class="number">2</span>]/<span class="number">2.0</span>), <span class="built_in">int</span>(box2[<span class="number">1</span>]+box2[<span class="number">3</span>]/<span class="number">2.0</span>)</span><br><span class="line">    <span class="comment"># è·å–çŸ©å½¢æ¡†äº¤é›†å¯¹åº”çš„å·¦ä¸Šè§’å’Œå³ä¸‹è§’çš„åæ ‡ï¼ˆintersectionï¼‰</span></span><br><span class="line">    xx1 = np.<span class="built_in">max</span>([xmin1, xmin2])</span><br><span class="line">    yy1 = np.<span class="built_in">max</span>([ymin1, ymin2])</span><br><span class="line">    xx2 = np.<span class="built_in">min</span>([xmax1, xmax2])</span><br><span class="line">    yy2 = np.<span class="built_in">min</span>([ymax1, ymax2])</span><br><span class="line">    <span class="comment"># è®¡ç®—ä¸¤ä¸ªçŸ©å½¢æ¡†é¢ç§¯</span></span><br><span class="line">    area1 = (xmax1-xmin1) * (ymax1-ymin1) </span><br><span class="line">    area2 = (xmax2-xmin2) * (ymax2-ymin2)</span><br><span class="line">    inter_area = (np.<span class="built_in">max</span>([<span class="number">0</span>, xx2-xx1])) * (np.<span class="built_in">max</span>([<span class="number">0</span>, yy2-yy1]))ã€€<span class="comment">#è®¡ç®—äº¤é›†é¢ç§¯</span></span><br><span class="line">    iou = inter_area / (area1+area2-inter_area+<span class="number">1e-6</span>) ã€€<span class="comment">#è®¡ç®—äº¤å¹¶æ¯”</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iou</span><br></pre></td></tr></table></figure><h4 id="NMS"><a href="#NMS" class="headerlink" title="NMS"></a>NMS</h4><p>å½“æˆ‘ä»¬çš„anchoré€šè¿‡<strong>softmax</strong>åˆ†ç±»åï¼Œç­›é€‰å‡ºäº†positive anchorï¼Œè¿™æ—¶å€™å°±åˆ°äº†RPNçš„æœ€åä¸€æ­¥äº†ï¼Œä½¿ç”¨<strong>NMS(Non-Maximum Suppression)</strong> å¯¹æˆ‘ä»¬çš„positive anchorè¿›è¡Œæœ€åä¸€æ­¥çš„ç­›é€‰ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ‰€æœ‰çš„positive anchoræŒ‰ç…§åˆ†ç±»scoreè¿›è¡Œæ’åºï¼Œ</p><p>å°†scoreæœ€å¤§çš„é‚£ä¸ªåŠ å…¥åˆ°æœ€ç»ˆçš„æ£€æµ‹ç»“æœé›†åˆä¸­ï¼Œç›´åˆ°positive anchoré›†åˆä¸­æ‰€æœ‰å¤§äºé˜ˆå€¼çš„anchorå…¨éƒ¨åŠ åˆ°æ£€æµ‹ç»“æœé›†åˆä¸­ï¼Œå³positive anchoré›†åˆä¸ºç©ºã€‚</p><p><img src="/2021/02/14/cv/faster-rcnn/606386-20170826153025589-977347485.png" alt="606386-20170826153025589-977347485"></p><p>å°±åƒä¸Šé¢çš„å›¾ç‰‡ä¸€æ ·ï¼Œå®šä½ä¸€ä¸ªè½¦è¾†ï¼Œæœ€åç®—æ³•å°±æ‰¾å‡ºäº†ä¸€å †çš„æ–¹æ¡†ï¼Œæˆ‘ä»¬éœ€è¦åˆ¤åˆ«å“ªäº›çŸ©å½¢æ¡†æ˜¯æ²¡ç”¨çš„ã€‚éæå¤§å€¼æŠ‘åˆ¶çš„æ–¹æ³•æ˜¯ï¼šå…ˆå‡è®¾æœ‰6ä¸ªçŸ©å½¢æ¡†ï¼Œæ ¹æ®åˆ†ç±»å™¨çš„ç±»åˆ«åˆ†ç±»æ¦‚ç‡åšæ’åºï¼Œå‡è®¾ä»å°åˆ°å¤§å±äºè½¦è¾†çš„æ¦‚ç‡ åˆ†åˆ«ä¸ºAã€Bã€Cã€Dã€Eã€Fã€‚</p><ol><li><p>ä»æœ€å¤§æ¦‚ç‡çŸ©å½¢æ¡†Få¼€å§‹ï¼Œåˆ†åˆ«åˆ¤æ–­A~Eä¸Fçš„é‡å åº¦IOUæ˜¯å¦å¤§äºæŸä¸ªè®¾å®šçš„é˜ˆå€¼;</p></li><li><p>å‡è®¾Bã€Dä¸Fçš„é‡å åº¦è¶…è¿‡é˜ˆå€¼ï¼Œé‚£ä¹ˆå°±æ‰”æ‰Bã€Dï¼›å¹¶æ ‡è®°ç¬¬ä¸€ä¸ªçŸ©å½¢æ¡†Fï¼Œæ˜¯æˆ‘ä»¬ä¿ç•™ä¸‹æ¥çš„ã€‚</p></li><li><p>ä»å‰©ä¸‹çš„çŸ©å½¢æ¡†Aã€Cã€Eä¸­ï¼Œé€‰æ‹©æ¦‚ç‡æœ€å¤§çš„Eï¼Œç„¶ååˆ¤æ–­Eä¸Aã€Cçš„é‡å åº¦ï¼Œé‡å åº¦å¤§äºä¸€å®šçš„é˜ˆå€¼ï¼Œé‚£ä¹ˆå°±æ‰”æ‰ï¼›å¹¶æ ‡è®°Eæ˜¯æˆ‘ä»¬ä¿ç•™ä¸‹æ¥çš„ç¬¬äºŒä¸ªçŸ©å½¢æ¡†ã€‚</p></li></ol><p>å°±è¿™æ ·ä¸€ç›´é‡å¤ï¼Œæ‰¾åˆ°æ‰€æœ‰è¢«ä¿ç•™ä¸‹æ¥çš„çŸ©å½¢æ¡†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">py_cpu_nms</span>(<span class="params">dets, thresh</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;Pure Python NMS baseline.&quot;&quot;&quot;</span></span><br><span class="line">    x1 = dets[:, <span class="number">0</span>]</span><br><span class="line">    y1 = dets[:, <span class="number">1</span>]</span><br><span class="line">    x2 = dets[:, <span class="number">2</span>]</span><br><span class="line">    y2 = dets[:, <span class="number">3</span>]</span><br><span class="line">    scores = dets[:, <span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">    areas = (x2 - x1 + <span class="number">1</span>) * (y2 - y1 + <span class="number">1</span>)</span><br><span class="line">    order = scores.argsort()[::-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    keep = []</span><br><span class="line">    <span class="keyword">while</span> order.size &gt; <span class="number">0</span>:</span><br><span class="line">        i = order[<span class="number">0</span>]</span><br><span class="line">        keep.append(i)</span><br><span class="line">        xx1 = np.maximum(x1[i], x1[order[<span class="number">1</span>:]])</span><br><span class="line">        yy1 = np.maximum(y1[i], y1[order[<span class="number">1</span>:]])</span><br><span class="line">        xx2 = np.minimum(x2[i], x2[order[<span class="number">1</span>:]])</span><br><span class="line">        yy2 = np.minimum(y2[i], y2[order[<span class="number">1</span>:]])</span><br><span class="line"></span><br><span class="line">        w = np.maximum(<span class="number">0.0</span>, xx2 - xx1 + <span class="number">1</span>)</span><br><span class="line">        h = np.maximum(<span class="number">0.0</span>, yy2 - yy1 + <span class="number">1</span>)</span><br><span class="line">        inter = w * h</span><br><span class="line">        ovr = inter / (areas[i] + areas[order[<span class="number">1</span>:]] - inter)</span><br><span class="line"></span><br><span class="line">        inds = np.where(ovr &lt;= thresh)[<span class="number">0</span>]</span><br><span class="line">        order = order[inds + <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> keep</span><br></pre></td></tr></table></figure><h3 id="ROI-pooling"><a href="#ROI-pooling" class="headerlink" title="ROI-pooling"></a>ROI-pooling</h3><p>ROI-poolingæ˜¯æ± åŒ–çš„ä¸€ç§ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯å¯¹ROIçš„æ± åŒ–ï¼Œä»–çš„ç‰¹ç‚¹æ˜¯è¾“å…¥å›¾åƒçš„å°ºåº¦ä¸åŒï¼Œè¾“å‡ºå›¾åƒçš„å°ºåº¦ç›¸åŒï¼Œ</p><h4 id="è¾“å…¥"><a href="#è¾“å…¥" class="headerlink" title="è¾“å…¥"></a>è¾“å…¥</h4><ol><li>åŸå§‹çš„feature mapï¼ˆä¸RPNéƒ¨åˆ†å…±äº«ï¼‰</li><li>RPNè¾“å‡ºçš„proposal boxes</li></ol><h4 id="è¾“å‡º"><a href="#è¾“å‡º" class="headerlink" title="è¾“å‡º"></a>è¾“å‡º</h4><p>å°†å¾—åˆ°çš„roiæ˜ å°„å›åŸå›¾çš„feature mapï¼Œå¹¶å¯¹feature mapè¿›è¡Œpooled_wï¼Œpooled_hå¤§å°ç­‰åˆ†ï¼Œç„¶åå¯¹ç­‰åˆ†çš„æ¯ä¸ªåŒºåŸŸè¿›è¡Œmax poolingï¼Œä»è€Œå¾—åˆ°å›ºå®šå¤§å°çš„feature mapï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ç”¨å—é™äºroiå’Œfeature mapå¤§å°ï¼Œå®ç°äº†å›ºå®šé•¿åº¦è¾“å‡ºï¼ŒåŠ å¿«å¤„ç†é€Ÿåº¦ã€‚</p><h3 id="Classification"><a href="#Classification" class="headerlink" title="Classification"></a>Classification</h3><p>å½“æˆ‘ä»¬å¾—åˆ°äº†ROI-poolingè¾“å‡ºçš„feature mapå’ŒRPNè¾“å‡ºçš„proposal boxesä¹‹åï¼Œå°±å¯ä»¥è¿›è¡Œåˆ†ç±»äº†ã€‚é€šè¿‡full connectå’Œsoftmaxè®¡ç®—æ¯ä¸ªproposalå±äºå“ªä¸ªç±»åˆ«ï¼Œå¹¶è¾“å‡ºcls_probï¼ŒåŒæ—¶å†æ¬¡åˆ©ç”¨bounding box regressionå¯¹é¢„æµ‹æ¡†è¿›è¡Œä¿®æ­£ï¼Œç”¨äºå¾—åˆ°æ›´åŠ ç²¾å‡†çš„ç›®æ ‡æ£€æµ‹æ¡†ã€‚</p><p><img src="/2021/02/14/cv/faster-rcnn/v2-9377a45dc8393d546b7b52a491414ded_720w.jpg" alt="v2-9377a45dc8393d546b7b52a491414ded_720w"></p><p>ç”±ä¸Šå›¾å¯çŸ¥ï¼Œåˆ†ç±»ç½‘ç»œä¸€å…±åšäº†ä¸¤ä»¶äº‹</p><ol><li>é€šè¿‡å…¨è¿æ¥å’Œsoftmaxå¯¹proposalsè¿›è¡Œåˆ†ç±»</li><li>å†æ¬¡å¯¹proposalsè¿›è¡Œbounding box regressionï¼Œè·å–æ›´é«˜ç²¾åº¦çš„rect box</li></ol><h2 id="å‚è€ƒæ–‡çŒ®"><a href="#å‚è€ƒæ–‡çŒ®" class="headerlink" title="å‚è€ƒæ–‡çŒ®"></a>å‚è€ƒæ–‡çŒ®</h2><p><a href="https://zhuanlan.zhihu.com/p/24916624">https://zhuanlan.zhihu.com/p/24916624</a></p><p><a href="https://zhuanlan.zhihu.com/p/82185598">https://zhuanlan.zhihu.com/p/82185598</a></p><p><a href="https://zhuanlan.zhihu.com/p/31426458">https://zhuanlan.zhihu.com/p/31426458</a></p><p><a href="https://zhuanlan.zhihu.com/p/102978748">https://zhuanlan.zhihu.com/p/102978748</a></p><p><a href="https://blog.csdn.net/cj1561435010/article/details/106649040">https://blog.csdn.net/cj1561435010/article/details/106649040</a></p><p><a href="https://zhuanlan.zhihu.com/p/94799295">https://zhuanlan.zhihu.com/p/94799295</a></p>]]></content>
      
      
      <categories>
          
          <category> Computer Vision </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Computer Vision </tag>
            
            <tag> Object Detection </tag>
            
            <tag> Two Stage Algorithm </tag>
            
            <tag> anchor based </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ¢¯åº¦ä¸‹é™</title>
      <link href="2020/06/10/machine_learning/gradient_descent/"/>
      <url>2020/06/10/machine_learning/gradient_descent/</url>
      
        <content type="html"><![CDATA[<h1 id="æ¢¯åº¦ä¸‹é™"><a href="#æ¢¯åº¦ä¸‹é™" class="headerlink" title="æ¢¯åº¦ä¸‹é™"></a>æ¢¯åº¦ä¸‹é™</h1><h2 id="åŸºæœ¬æ¦‚å¿µï¼š"><a href="#åŸºæœ¬æ¦‚å¿µï¼š" class="headerlink" title="åŸºæœ¬æ¦‚å¿µï¼š"></a>åŸºæœ¬æ¦‚å¿µï¼š</h2><p>æ¢¯åº¦ä¸‹é™æ˜¯åœ¨ç›‘ç£å­¦ä¹ ä¸­ï¼Œä¸ºäº†ä¼˜åŒ–æ¨¡å‹å‚æ•°ï¼Œæ±‚å‡ºæŸå¤±å‡½æ•°J(Î¸i)(loss function)å–å¾—æœ€å°å€¼æ—¶ï¼Œå¯¹åº”çš„å‚æ•°Î¸å€¼çš„ä¸€ç§è¿­ä»£ç®—æ³•</p><h2 id="æ•°å­¦å…¬å¼ï¼š"><a href="#æ•°å­¦å…¬å¼ï¼š" class="headerlink" title="æ•°å­¦å…¬å¼ï¼š"></a>æ•°å­¦å…¬å¼ï¼š</h2><p>â€‹    å¯¹äºä¸€èˆ¬çš„çº¿è¡Œå›å½’ï¼Œå‡è®¾å‡½æ•°å¯è¡¨ç¤ºä¸ºï¼š<br>$$<br>h_\theta(x) = \theta_0x_0 + \theta_1x_1 + \theta_2x_3 + â€¦ + \theta_nx_n<br>$$<br>â€‹    å…¶ä¸­nä¸ºæ ·æœ¬ç‰¹å¾æ•°ï¼Œ$\theta_i$(i = 0, 1, 2 â€¦ n) ä¸ºæ¨¡å‹å‚æ•°ï¼Œ$x_i$(i = 0, 1, 2 â€¦ n)  ä¸ºæ¯ä¸ªæ ·æœ¬çš„nä¸ªç‰¹å¾å€¼ï¼Œå°†ä¸Šå¼åŒ–ç®€åå¯å¾—ï¼š<br>$$<br>h_\theta(x) = \sum_{i=0}^n\theta_ix_i = \theta^Tx<br>$$<br>â€‹    å¯¹äºä¸Šé¢çš„å‡è®¾å‡½æ•°ï¼Œå…¶æŸå¤±å‡½æ•° ï¼ˆå¹³æ–¹æŸå¤±å‡½æ•°ï¼‰å¯è¡¨ç¤ºä¸ºï¼š<br>$$<br>J(\theta_1,\theta_2â€¦,\theta_n) = \frac{1}{2m} \sum_{j=0}^m(h_\theta(x_0^j,x_1^jâ€¦x_n^j)-y^j)^2<br>$$<br>å…¶ä¸­mè¡¨ç¤ºä¸ºæ ·æœ¬ä¸ªæ•°ã€‚</p><p>ç”±æ­¤ï¼Œæ¢¯åº¦ä¸‹é™å…¬å¼å¯è¡¨ç¤ºä¸ºï¼š<br>$$<br>\theta_i=\theta_i-\alpha\frac{\partial}{\partial\theta_i}J(\theta_1,\theta_2â€¦,\theta_n)<br>$$<br>å°†æŸå¤±å‡½æ•°å¸¦å…¥ä¸Šå¼å¹¶è®¡ç®—å¯å¾—ï¼š<br>$$<br>\theta_i=\theta_i-\alpha\frac{1}{m} \sum_{j=0}^m(h_\theta(x_0^j,x_1^jâ€¦x_n^j)-y^j)x_i^j<br>$$</p><h2 id="å…¬å¼è¯¦è§£ï¼š"><a href="#å…¬å¼è¯¦è§£ï¼š" class="headerlink" title="å…¬å¼è¯¦è§£ï¼š"></a>å…¬å¼è¯¦è§£ï¼š</h2><p>ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªæœ€ç®€å•çš„ä¸€å…ƒçº¿æ€§å›å½’çš„å‡è®¾å‡½æ•°ä¸¾ä¾‹ï¼Œå…¶è¡¨è¾¾å¼ä¸ºï¼š$h_\theta(x) = \theta_0x_0+\theta_1x_1$ï¼Œæˆ‘ä»¬è§„å®š$x_0= 1$</p><p>ä½†æ˜¯æˆ‘ä»¬åœ¨æ¨å¯¼å…¬å¼å‰éœ€è¦ç†è§£ä»¥ä¸‹å‡ ä¸ªæ¦‚å¿µå’Œé—®é¢˜ï¼Œä»¥åŠ©äºæˆ‘ä»¬æ›´å¥½çš„ç†è§£å¹¶æ¨å¯¼å…¬å¼</p><h3 id="ä»€ä¹ˆæ˜¯å‡è®¾å‡½æ•°ï¼š"><a href="#ä»€ä¹ˆæ˜¯å‡è®¾å‡½æ•°ï¼š" class="headerlink" title="ä»€ä¹ˆæ˜¯å‡è®¾å‡½æ•°ï¼š"></a>ä»€ä¹ˆæ˜¯å‡è®¾å‡½æ•°ï¼š</h3><p>â€‹        å‡è®¾å‡½æ•°æ˜¯å¯¹ç°æœ‰è®­ç»ƒé›†çš„çº¿æ€§æ‹Ÿåˆï¼Œä»¥å¯»æ±‚å‚æ•°çš„æœ€ä½³ä¼°è®¡å€¼ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬çš„å­¦ä¹ æ¨¡å‹ï¼Œå†³å®šäº†ç®—æ³•çš„æ˜¯å¦èƒ½å¤Ÿç²¾å‡†çš„é¢„æµ‹ï¼Œæ¯”å¦‚æˆ¿ä»·é¢„æµ‹ï¼Œç»™å®šäº†ä¸€å®šæ•°é‡ï¼Œä¸€å®šé¢ç§¯çš„æˆ¿å±‹ä»·æ ¼ä½œä¸ºè®­ç»ƒé›†ï¼Œå½“æˆ‘ä»¬ä»»æ„ç»™å‡ºä¸€å¥—æˆ¿å­çš„é¢ç§¯æ—¶ï¼Œéœ€è¦å‡†ç¡®å¾—é¢„æµ‹å‡ºæˆ¿å±‹çš„ä»·æ ¼ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼š"><a href="#ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼š" class="headerlink" title="ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼š"></a>ä»€ä¹ˆæ˜¯æŸå¤±å‡½æ•°ï¼š</h3><p>â€‹        è¿™æ˜¯ä¸€ä¸ªç”¨äºè¡¡é‡æˆ‘ä»¬çš„ç›‘ç£å­¦ä¹ æ¨¡å‹å¥½åçš„æ ‡å‡†ä¹‹ä¸€ï¼Œæˆ‘ä»¬å°†å…³äºæŸä¸ªæ ·æœ¬çš„é¢„æµ‹å€¼ï¼ˆå°†å‚æ•°xä»£å…¥å‡è®¾å‡½æ•°åçš„ç»“æœï¼‰ä¸å®é™…å€¼ï¼ˆæ ·æœ¬ç»™äºˆçš„yå…³äºxçš„å€¼ï¼‰çš„å·®å€¼ç§°ä¸ºæŸå¤±ï¼ŒæŸå¤±è¶Šå°ï¼Œæ¨¡å‹è¶Šå¥½ï¼Œé‚£ä¹ˆç”¨äºè®¡ç®—è¿™ä¸ªæŸå¤±çš„å‡½æ•°å°±å«åšæŸå¤±å‡½æ•°</p><p>â€‹        ç”±æŸå¤±å‡½æ•°å¯çŸ¥ï¼šå½“æŸå¤±å‡½æ•°å–å¾—æœ€å°å€¼æ—¶ï¼Œé‚£ä¹ˆå…¶å¯¹åº”çš„å‚æ•°Î¸çš„å€¼ï¼Œåˆ™æ˜¯æ¨¡å‹çš„æœ€ä¼˜å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ—¶ä»¥Î¸ä¸ºå‚æ•°çš„å­¦ä¹ æ¨¡å‹æ˜¯æœ€å¿§çš„ï¼Œèƒ½è¾¾åˆ°æœ€ç²¾å‡†çš„é¢„æµ‹ç»“æœ</p><p>â€‹        é‚£ä¹ˆé—®é¢˜å°±è½¬å˜æˆï¼š<strong>å¦‚ä½•åœ¨æŸå¤±å‡½æ•°å–å¾—æœ€å°å€¼æ—¶ï¼Œæ±‚å‡ºå…¶å‚æ•°$\theta$çš„å€¼ã€‚</strong>åœ¨é«˜ç­‰æ•°å­¦ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ï¼Œåªéœ€è¦å¯¹å‡½æ•°æ±‚å¯¼ï¼Œä»¤å®ƒç­‰äºé›¶ï¼Œå…¶è§£æè§£ä¸ºå‡½æ•°å–åˆ°æœ€å€¼æ—¶å¯¹åº”å‚æ•°çš„å€¼ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰å‡½æ•°éƒ½å¯ä»¥æ±‚å‡ºè§£æè§£ï¼Œæ­¤æ—¶ï¼Œå°±è¡ç”Ÿå‡ºäº†æ¢¯åº¦ä¸‹é™çš„æ–¹æ³•ï¼Œé€šè¿‡ä¸æ–­è¿­ä»£æ”¹å˜å‚æ•°çš„å€¼è¿›è¡Œè¯•æ¢ï¼Œç›´è‡³å…¶æ”¶æ•›ï¼Œå°±å¾—åˆ°äº†æˆ‘ä»¬éœ€è¦çš„å‚æ•°çš„è§£ï¼Œ</p><p><strong>é‚£ä¹ˆé—®é¢˜åˆæ¥äº†ï¼Œæ¢¯åº¦ä¸‹é™æ˜¯å¦‚ä½•å·¥ä½œçš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆåœ¨è¿­ä»£æ—¶è¦å‡å»æŸå¤±å‡½æ•°çš„åå¯¼å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯å…¶ä»–å€¼å‘¢ï¼Ÿ</strong></p><p>â€‹        æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåå¯¼æ•°çš„å‡ ä½•æ„ä¹‰æ˜¯å¤šå…ƒå‡½æ•°æ²¿åæ ‡è½´çš„å˜åŒ–ç‡ï¼Œä¹Ÿå°±æ˜¯æ–œç‡ã€‚è¿™é‡Œæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªä¾‹å­ï¼Œæƒ³è±¡ä¸€ä¸‹æˆ‘ä»¬åœ¨ä¸€åº§å±±ä¸Šï¼Œæˆ‘ä»¬ç›®çš„æ˜¯ä¸‹å±±ï¼Œé‚£ä¹ˆè‡ªç„¶è€Œç„¶çš„æˆ‘ä»¬æƒ³åˆ°åœ¨èµ°æ¯ä¸€æ­¥ä¹‹å‰éœ€è¦ç¡®å®šèµ°çš„æ–¹å‘ã€‚</p><p>å±±å¡å›¾å¦‚ä¸‹ï¼š</p><p><img src="/2020/06/10/machine_learning/gradient_descent/v2-8847409b4b6a4cd174b4b75b33b29725_720w.jpg" alt="img"></p><p>â€‹    ä¸ºäº†æ›´å¿«çš„ä¸‹å±±ï¼Œæˆ‘ä»¬æœ€å¥½çš„é€‰æ³½è‚¯å®šæ˜¯é€‰æ‹©ä¸€æ¡æœ€é™¡å³­çš„ï¼ˆæ„å‘³ç€èŠ±è´¹æ—¶é—´å°‘ï¼Œä½œä¸ºè·ç¦»å¹¶ä¸è€ƒè™‘å®é™…å®‰å…¨æ€§ï¼‰çš„è·¯ã€‚â€æœ€é™¡å³­â€ æ˜ å°„åˆ°æˆ‘ä»¬çš„åæ ‡ç³»ä¸­å¯ä»¥è¡¨ç¤ºä¸ºæ›²é¢æ²¿ç€ä»»æ„æ–¹å‘å˜åŒ–ç‡æœ€å¤§çš„æ–¹å‘ï¼Œæ­¤æ—¶å¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ¦‚å¿µå«åšâ€æ–¹å‘å¯¼æ•°â€ï¼Œå®ƒå¯ä»¥ç”¨æ¥è¡¨ç¤ºæ›²é¢æ²¿ä»»æ„æ–¹å‘çš„æ–œç‡ï¼Œæœ‰äº†å®ƒæˆ‘ä»¬å°±å¯ä»¥æ±‚å‡ºâ€æœ€é™¡å³­â€çš„æ–¹å‘ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§æ–œç‡ã€‚</p><p>â€‹    å‡è®¾å±±å¡è¡¨ç¤ºä¸ºz = f(x,y), yæ–¹å‘çš„æ–œç‡å¯ç”±å¯¹yçš„åå¾®åˆ†å¾—åˆ° $f_y(x,y)sin\theta$ï¼Œxæ–¹å‘çš„æ–œç‡ä¹Ÿå¯ä»¥å¯¹xåå¾®åˆ†å¾—åˆ°$f_x(x,y)cos\theta$.</p><p>ç°åœ¨æˆ‘ä»¬æœ‰è¿™ä¹ˆä¸€ä¸ªéœ€æ±‚ï¼Œéœ€è¦æ±‚å‡ºuæ–¹å‘çš„æ–œç‡ï¼Œå•ä½å‘é‡$u = cos(\theta)j + sin(\theta)j$, æˆ‘ä»¬æŠŠè¿™ä¸ªæ–œç‡è®°ä½œ$D_uf$,å…¶è¡¨è¾¾å¼ä¸ºï¼š<br>$$<br>D_uf(x,y) = f_x(x,y)cos\theta + f_y(x,y)sin\theta<br>$$</p><p>ç°åœ¨æˆ‘ä»¬çš„ä¸»è§’â€æ¢¯åº¦â€ç»ˆäºè¦ç™»åœºäº†ï¼Œæ¢¯åº¦å°±æ˜¯è¿™ä¸ªâ€æœ€é™¡å³­â€çš„æ–¹å‘ï¼Œå®ƒçš„æ•°å­¦å«ä¹‰è¡¨ç¤ºä¸ºä¸€ä¸ªç”±æ–¹å‘å¯¼æ•°çš„æœ€å¤§å€¼ç»„æˆçš„å‘é‡ï¼Œè€Œå®ƒåœ¨æˆ‘ä»¬çš„ç®—æ³•ä¸­ï¼Œæ¢¯åº¦å°±æ˜¯ä¸€ä¸ªåŒ…å«äº†æ¨¡å‹å‚æ•°Î¸çš„å‘é‡ã€‚</p><p>è®¾ï¼š$A = (f_x(x,y), f_y(x,y))$ï¼Œ$I = (cos\theta, sin\theta)$ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å¾—åˆ°$D_Uf(x,y) = AÂ·I = |A| *|I|*cos\theta$ï¼Œæˆ‘ä»¬ä»¤æ¢¯åº¦ä¸º$J(x,y)$ï¼Œé‚£ä¹ˆ$J(x,y) = maxD_Uf(x,y) =|A| *|I|*cos0 = A = (f_x(x,y), f_y(x,y))$ï¼Œå…¶ä¸­$\theta$ä¸º0åº¦</p><p>åœ¨æ¢¯åº¦ä¸‹é™ç®—æ³•ä¸­ï¼Œæˆ‘ä»¬ä¸æ–­çš„å¯»æ‰¾åˆé€‚çš„æ–¹å‘ä¸‹å±±ï¼ˆå¯»æ‰¾åˆé€‚çš„å‚æ•°ï¼‰ä»¥è‡³äºæˆ‘ä»¬èƒ½åˆ°è¾¾å±±åº•ï¼ˆæ¢¯åº¦ä¸‹é™çš„è·ç¦»å°äºdï¼ˆè¶‹è¿‘äºé›¶ï¼‰ï¼‰</p><p>ç°åœ¨æˆ‘ä»¬å¯ä»¥å›ç­”ä¸Šé¢çš„å‡ ä¸ªé—®é¢˜äº†:</p><p>æ¢¯åº¦ä¸‹é™å°±æ˜¯åœ¨é€šè¿‡è¿­ä»£çš„æ–¹å¼å¯»æ‰¾ä¸€ä¸ªåˆé€‚çš„å‚æ•°$\theta$ä½¿å¾—æŸå¤±å‡½æ•°å€¼æ— é™è¶‹è¿‘äºé›¶ï¼ˆæ”¶æ•›ï¼‰ï¼Œä¹Ÿå°±æ˜¯æŸå¤±å‡½æ•°å–å¾—æœ€å°å€¼ï¼Œè€Œå‡å»æŸå¤±å‡½æ•°çš„åå¯¼çš„æ„ä¹‰å°±åœ¨äºï¼Œä¸ºäº†åŠ å¿«è¿­ä»£é€Ÿåº¦ï¼ˆä¾‹å­ä¸­çš„ä¸‹å±±é€Ÿåº¦ï¼‰ï¼Œèƒ½å¤Ÿæ›´å¿«çš„å¾—åˆ°æˆ‘ä»¬éœ€è¦çš„å‚æ•°\theta</p><p>åœ¨ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºæŸå¤±å‡½æ•°å€¼æ— é™è¶‹è¿‘äºé›¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç†è§£æˆæ¢¯åº¦ä¸­çš„æ¯ä¸€ä¸ªæ•°çš„ç»å¯¹å€¼éƒ½ä¸å¤§äºä¸€ä¸ªæ•°ï¼ˆè¿™ä¸ªæ•°æ˜¯äººä¸ºè®¾å®šçš„ï¼Œä¸€èˆ¬æ˜¯1e^-5ï¼Œè¿™å°†å†³å®šä½ çš„ç®—æ³•ä»€ä¹ˆæ—¶å€™ç»ˆæ­¢</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•å†™å‡ºä¸€å…ƒæ¢¯åº¦ä¸‹é™çš„è¿­ä»£å…¬å¼ï¼š</p><p>$$<br>\theta_0=\theta_0-\alpha(h_\theta(x_0)-y)x_0<br>$$</p><p>$$<br>\theta_1=\theta_1-\alpha(h_\theta(x_1)-y)x_1<br>$$</p><p>é‚£ä¹ˆç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¤šå…ƒæ¢¯åº¦ä¸‹é™çš„è¿­ä»£å…¬å¼ï¼Œå·²çŸ¥å¤šå…ƒçº¿æ€§å›å½’çš„å‡è®¾å‡½æ•°ä¸ºï¼š<br>$$<br>h_\theta(x) = \sum_{i=0}^n\theta_ix_i = \theta^Tx<br>$$</p><p>å¯¹äºæ¢¯åº¦ä¸‹é™çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ï¼š<br>$$<br>\theta_0=\theta_0-\alpha(h_\theta(x_0^{(j)})-y^{(j)})x_0^{(j)}<br>$$</p><p>$$<br>\theta_1=\theta_1-\alpha(h_\theta(x_1^{(j)})-y^{(j)})x_1^{(j)}<br>$$</p><p>$$<br>\cdots<br>$$</p><p>$$<br>\theta_n=\theta_n-\alpha(h_\theta(x_n^{(j)})-y^{(j)})x_n^{(j)}<br>$$</p><p>å…¶ä¸­ä¸Šæ ‡jè¡¨ç¤ºæ ·æœ¬ç´¢å¼•ï¼Œä¸‹æ ‡è¡¨ç¤ºç‰¹å¾ç´¢å¼•ï¼Œnè¡¨ç¤ºæ ·æœ¬æ€»æ•°</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ¯”è¾ƒç›´æ¥çš„æ–¹æ³•æ±‚å‚æ•°$\theta$ ï¼Œå«åšæ­£è§„æ–¹ç¨‹ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯å¯¼æ•°å€¼ç­‰äºé›¶<br>$$<br>\frac{\partial}{\partial\theta_i}J(\theta)=0<br>$$<br>å…¶ä¸­<br>$$<br>\theta=\left[\begin{matrix} \theta_0\\theta_1\\theta_2\\cdots\\theta_n \end{matrix}\right]<br>$$<br>ç°åœ¨æˆ‘ä»¬å¼€å§‹æ±‚è§£æ­£è§„æ–¹ç¨‹ï¼š</p><p>â€‹    å°†$J(\theta)$ä»£å…¥å¯å¾—ï¼š<br>$$<br>\frac{\partial}{\partial\theta_i}\frac{1}{2m} \sum_{j=0}^m(h_\theta(x_0^{(j)},x_1^{(j)}â€¦x_n^{(j)})-y^{(j)})^2 = 0<br>$$<br>â€‹    è®¡ç®—åå¯¼å¯å¾—ï¼š<br>$$<br>\frac{1}{m} \sum_{j=0}^m(h_\theta(x_0^{(j)},x_1^{(j)}â€¦x_n^{(j)})-y^{(j)})x_i^{(j)} = 0<br>$$<br>â€‹    ä¸ºäº†ç®€åŒ–å…¬å¼ï¼Œæˆ‘ä»¬å¯ä»¥å°†xï¼Œyï¼Œä¹Ÿå°±æ˜¯æ ·æœ¬ç‰¹å¾å€¼å’Œæ ·æœ¬å€¼ç”¨çŸ©é˜µå½¢å¼æ¥è¡¨ç¤ºï¼Œå…¶ä¸­ä¸Šæ ‡è¡¨ç¤ºæ ·æœ¬ï¼Œä¸‹æ ‡è¡¨ç¤ºç‰¹å¾ï¼š<br>$$<br>x =\left[\begin{matrix} x_0^1 &amp; x_1^1 &amp;x_2^1 &amp; \cdots&amp;x_n^1 \ x_0^2 &amp; x_1^2 &amp;x_2^2 &amp; \cdots&amp;x_n^2 \ &amp;&amp;\cdots \ x_0^n &amp; x_1^n &amp;x_2^n &amp; \cdots&amp;x_n^n \end{matrix}\right]<br>$$</p><p>$$<br>y=\left[\begin{matrix} y^1 \ y^2 \ \cdots \ y^n \end{matrix}\right]<br>$$</p><p>â€‹    ç°åœ¨æˆ‘ä»¬å¯¹ä¸Šå¼è¿›è¡Œç®€å•çš„åŒ–ç®€ï¼Œå¹¶æŠŠå¼ä¸­çš„$J(\theta)$æ›¿æ¢æ‰å¾—ï¼š<br>$$<br>\sum_{j=0}^m(\theta x^T-y^{(j)})x_i^{(j)} = 0<br>$$</p><p>$$<br>\sum_{j=0}^m\theta x^T x_i^{(j)} = \sum_{j=0}^mx_i^{(j)}y^{(j)}<br>$$</p><p>â€‹        ç”±ä¸Šå¼å¯çŸ¥ï¼Œå…¶ä¸­$\sum_{j=0}^mx^T x_i^{(j)}$å®è´¨ä¸Šå°±æ˜¯æ ·æœ¬çŸ©é˜µå’Œä»–è‡ªèº«çš„è½¬ç½®ç›¸ä¹˜ï¼Œå¯ä»¥è½¬åŒ–æˆ$x^Tx$ï¼Œè€Œå³è¾¹ç»è¿‡è®¡ç®—å¯å¾—ç­‰äº$x^Ty$ï¼Œæ˜¯ä¸€ä¸ªn x 1çš„çŸ©é˜µï¼Œåˆå› ä¸º$\theta$æ˜¯ä¸ªnç»´å‘é‡ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªn x 1çš„çŸ©é˜µï¼Œä¸ºäº†ä½¿ç­‰å¼æˆç«‹ï¼Œå› æ­¤$\theta$éœ€è¦å·¦ä¹˜$x^Tx$ï¼Œå› æ­¤ç­‰å¼å¯åŒ–ç®€ä¸ºï¼š<br>$$<br>x^Tx\theta=x^Ty<br>$$<br>æ ¹æ®é€†çŸ©é˜µçš„æ€§è´¨å¯å¾—ï¼š<br>$$<br>\theta = (x^Tx)^{-1}x^Ty<br>$$</p><p>æ‰€ä»¥ç”±æ­£è§„æ–¹ç¨‹ï¼ˆnormal equation)å¯å¾—ï¼š         $\theta = (x^Tx)^{-1}x^Ty$  </p><h2 id="å‚è€ƒæ–‡çŒ®ï¼š"><a href="#å‚è€ƒæ–‡çŒ®ï¼š" class="headerlink" title="å‚è€ƒæ–‡çŒ®ï¼š"></a>å‚è€ƒæ–‡çŒ®ï¼š</h2><ol><li><p>æ¢¯åº¦å’Œæ–¹å‘å¯¼æ•°çš„æ„ä¹‰ï¼š<a href="https://www.zhihu.com/question/36301367">https://www.zhihu.com/question/36301367</a></p></li><li><p>æ¢¯åº¦ä¸‹é™ç®—æ³•æ‰§è¡Œè¿‡ç¨‹ï¼š<a href="https://blog.csdn.net/weixin_34266504/article/details/94540839">https://blog.csdn.net/weixin_34266504/article/details/94540839</a></p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Machine Learning </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æœºå™¨å­¦ä¹ åŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Gitå¸¸ç”¨æ“ä½œåˆé›†</title>
      <link href="2020/05/08/tool_operation/git/"/>
      <url>2020/05/08/tool_operation/git/</url>
      
        <content type="html"><![CDATA[<h1 id="Gitå¸¸ç”¨æ“ä½œ"><a href="#Gitå¸¸ç”¨æ“ä½œ" class="headerlink" title="Gitå¸¸ç”¨æ“ä½œ"></a>Gitå¸¸ç”¨æ“ä½œ</h1><h2 id="æŸ¥çœ‹å½“å‰åˆ†æ”¯ï¼š"><a href="#æŸ¥çœ‹å½“å‰åˆ†æ”¯ï¼š" class="headerlink" title="æŸ¥çœ‹å½“å‰åˆ†æ”¯ï¼š"></a>æŸ¥çœ‹å½“å‰åˆ†æ”¯ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch</span><br></pre></td></tr></table></figure><h2 id="æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼š"><a href="#æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼š" class="headerlink" title="æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼š"></a>æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -a</span><br></pre></td></tr></table></figure><h2 id="æ›´æ–°æœ¬åœ°åˆ†æ”¯ï¼š"><a href="#æ›´æ–°æœ¬åœ°åˆ†æ”¯ï¼š" class="headerlink" title="æ›´æ–°æœ¬åœ°åˆ†æ”¯ï¼š"></a>æ›´æ–°æœ¬åœ°åˆ†æ”¯ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git remote update origin --prune</span><br><span class="line">git fetch origin --prune    git branch -a</span><br></pre></td></tr></table></figure><h2 id="åˆ‡æ¢æœ¬åœ°åˆ†æ”¯ï¼ˆè‹¥åˆ†æ”¯åœ¨æœ¬åœ°æœªä¸orginåŒæ­¥ï¼‰ï¼š"><a href="#åˆ‡æ¢æœ¬åœ°åˆ†æ”¯ï¼ˆè‹¥åˆ†æ”¯åœ¨æœ¬åœ°æœªä¸orginåŒæ­¥ï¼‰ï¼š" class="headerlink" title="åˆ‡æ¢æœ¬åœ°åˆ†æ”¯ï¼ˆè‹¥åˆ†æ”¯åœ¨æœ¬åœ°æœªä¸orginåŒæ­¥ï¼‰ï¼š"></a>åˆ‡æ¢æœ¬åœ°åˆ†æ”¯ï¼ˆè‹¥åˆ†æ”¯åœ¨æœ¬åœ°æœªä¸orginåŒæ­¥ï¼‰ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b [branch name]</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š"><a href="#åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š" class="headerlink" title="åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š"></a>åˆ é™¤è¿œç¨‹åˆ†æ”¯ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin --delete [branch name]</span><br></pre></td></tr></table></figure><h2 id="åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼ˆdevåˆ†æ”¯ï¼‰ï¼š"><a href="#åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼ˆdevåˆ†æ”¯ï¼‰ï¼š" class="headerlink" title="åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼ˆdevåˆ†æ”¯ï¼‰ï¼š"></a>åˆ é™¤æœ¬åœ°åˆ†æ”¯ï¼ˆdevåˆ†æ”¯ï¼‰ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git branch -D dev</span><br></pre></td></tr></table></figure><h2 id="æ‹‰å–ä»£ç ï¼ˆæ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼‰ï¼š"><a href="#æ‹‰å–ä»£ç ï¼ˆæ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼‰ï¼š" class="headerlink" title="æ‹‰å–ä»£ç ï¼ˆæ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼‰ï¼š"></a>æ‹‰å–ä»£ç ï¼ˆæ‹‰å–æŒ‡å®šåˆ†æ”¯ï¼‰ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;è¿œç¨‹åˆ†æ”¯å&gt;:&lt;æœ¬åœ°åˆ†æ”¯å&gt;</span><br></pre></td></tr></table></figure><h2 id="æ‹‰å–ä»£ç ï¼ˆä¸å½“å‰åˆ†æ”¯åˆå¹¶ï¼‰"><a href="#æ‹‰å–ä»£ç ï¼ˆä¸å½“å‰åˆ†æ”¯åˆå¹¶ï¼‰" class="headerlink" title="æ‹‰å–ä»£ç ï¼ˆä¸å½“å‰åˆ†æ”¯åˆå¹¶ï¼‰:"></a>æ‹‰å–ä»£ç ï¼ˆä¸å½“å‰åˆ†æ”¯åˆå¹¶ï¼‰:</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull &lt;è¿œç¨‹ä¸»æœºå&gt; &lt;è¿œç¨‹åˆ†æ”¯å&gt;</span><br></pre></td></tr></table></figure><h2 id="æ‰‹åŠ¨åˆå¹¶ï¼ˆæ‰“å¼€mergeå·¥å…·ï¼‰-ï¼š"><a href="#æ‰‹åŠ¨åˆå¹¶ï¼ˆæ‰“å¼€mergeå·¥å…·ï¼‰-ï¼š" class="headerlink" title="æ‰‹åŠ¨åˆå¹¶ï¼ˆæ‰“å¼€mergeå·¥å…·ï¼‰  ï¼š"></a>æ‰‹åŠ¨åˆå¹¶ï¼ˆæ‰“å¼€mergeå·¥å…·ï¼‰  ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git merge tool </span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰“å¼€beyondcompareåå·¦è¾¹æ˜¯å½“å‰åˆ†æ”¯ä»£ç ï¼Œä¸­é—´æ˜¯ä¿®æ”¹å‰çš„ä»£ç ï¼Œå³è¾¹æ˜¯è¢«åˆå¹¶åˆ†æ”¯çš„ä»£ç ï¼Œç‚¹å‡»å·¦è¾¹ç®­å¤´è¿›è¡Œé€‰æ‹©å¹¶åˆå¹¶</span></span><br></pre></td></tr></table></figure><p><img src="/2020/05/08/tool_operation/git/clipboard.png" alt="img"></p><h2 id="åˆ é™¤è¿œç«¯æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆä¿ç•™æœ¬åœ°æ–‡ä»¶ï¼‰"><a href="#åˆ é™¤è¿œç«¯æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆä¿ç•™æœ¬åœ°æ–‡ä»¶ï¼‰" class="headerlink" title="åˆ é™¤è¿œç«¯æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆä¿ç•™æœ¬åœ°æ–‡ä»¶ï¼‰:"></a>åˆ é™¤è¿œç«¯æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆä¿ç•™æœ¬åœ°æ–‡ä»¶ï¼‰:</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git rm --cache filename</span><br><span class="line">git rm -r --cache dirname</span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºå’Œåˆ é™¤æ ‡ç­¾ï¼š"><a href="#åˆ›å»ºå’Œåˆ é™¤æ ‡ç­¾ï¼š" class="headerlink" title="åˆ›å»ºå’Œåˆ é™¤æ ‡ç­¾ï¼š"></a>åˆ›å»ºå’Œåˆ é™¤æ ‡ç­¾ï¼š</h2><h3 id="åˆ›å»ºï¼š"><a href="#åˆ›å»ºï¼š" class="headerlink" title="åˆ›å»ºï¼š"></a>åˆ›å»ºï¼š</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git tag &lt;æ ‡ç­¾å&gt;</span><br><span class="line"></span><br><span class="line">git push origin &lt;æ ‡ç­¾å&gt;</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤ï¼š"><a href="#åˆ é™¤ï¼š" class="headerlink" title="åˆ é™¤ï¼š"></a>åˆ é™¤ï¼š</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git tag -d &lt;æ ‡ç­¾å&gt;</span><br><span class="line">git push origin :refs/tags/æ ‡ç­¾å</span><br></pre></td></tr></table></figure><h2 id="å°†tagæ£€å‡ºçš„åŠæ³•ï¼š"><a href="#å°†tagæ£€å‡ºçš„åŠæ³•ï¼š" class="headerlink" title="å°†tagæ£€å‡ºçš„åŠæ³•ï¼š"></a>å°†tagæ£€å‡ºçš„åŠæ³•ï¼š</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b &lt;new branch&gt; &lt;tag name&gt;</span><br></pre></td></tr></table></figure><h2 id="è¿ç§»ä»“åº“ï¼ˆä»githubåˆ°gitee"><a href="#è¿ç§»ä»“åº“ï¼ˆä»githubåˆ°gitee" class="headerlink" title="è¿ç§»ä»“åº“ï¼ˆä»githubåˆ°gitee)"></a>è¿ç§»ä»“åº“ï¼ˆä»githubåˆ°gitee)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git remote remove origin</span><br><span class="line">git remote add origin https://gitee/com/Ztt./homework.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·æ“ä½œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·æ“ä½œ </tag>
            
            <tag> ç‰ˆæœ¬ç®¡ç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythoné¡¹ç›®æ‰“åŒ…</title>
      <link href="2020/04/20/tool_operation/python_pack/"/>
      <url>2020/04/20/tool_operation/python_pack/</url>
      
        <content type="html"><![CDATA[<h1 id="pythoné¡¹ç›®æ‰“åŒ…ï¼Œä½¿ç”¨pipå®‰è£…"><a href="#pythoné¡¹ç›®æ‰“åŒ…ï¼Œä½¿ç”¨pipå®‰è£…" class="headerlink" title="pythoné¡¹ç›®æ‰“åŒ…ï¼Œä½¿ç”¨pipå®‰è£…"></a>pythoné¡¹ç›®æ‰“åŒ…ï¼Œä½¿ç”¨pipå®‰è£…</h1><h2 id="åŒ…ç»“æ„"><a href="#åŒ…ç»“æ„" class="headerlink" title="åŒ…ç»“æ„"></a>åŒ…ç»“æ„</h2><p>åº“å‘å¸ƒå‰å…ˆç¡®è®¤ä½ çš„åº“æ˜¯ä»¥ä¸‹è¿™ä¸ªç»“æ„çš„.<br>project æ˜¯æœ€å¤–å±‚çš„åº“å<br>package1 æ˜¯é‡Œé¢çš„åŒ…å<br>module.py æ˜¯å…·ä½“çš„æ¨¡å—.<br><code>setup.py</code> å’Œ<code>__init__.py</code> æ˜¯å¿…é¡»åŒ…å«çš„,ä¸‹é¢ä¼šè®²è§£</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">project</span><br><span class="line">    â”â” setup.py</span><br><span class="line">    â”â” package1</span><br><span class="line">    â”‚   â” __init__.py</span><br><span class="line">    â”‚   â” module1.py</span><br><span class="line">    â”‚   â”” module2.py</span><br><span class="line">    â””â”€ package2</span><br><span class="line">        â” __init__.py</span><br><span class="line">        â” module3.py</span><br><span class="line">        â”” module4.py</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä»¥model.pyä½œä¸ºä¾‹å­</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="comment"># module.py å¸¸ç”¨æ¨¡å—</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    print(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    hello()</span><br></pre></td></tr></table></figure><p><strong>setup.py</strong>æ˜¯å¿…é¡»çš„ï¼Œä¸”åº”è¯¥æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­ï¼Œé‡Œé¢çš„nameï¼Œversionï¼Œauthorï¼Œauthor_emailç­‰éƒ½æ˜¯å¯ä»¥è‡ªå®šä¹‰çš„ï¼Œnameå†³å®šäº†ä½ æ‰“åŒ…å®Œåå®‰è£…çš„åå­—ï¼Œinstall_requiresåœ¨å®‰è£…æ—¶pythonä¼šè‡ªåŠ¨å¸®ä½ æ£€æŸ¥æ˜¯å¦æœ‰ç›¸åº”çš„ä¾èµ–åº“</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> setuptools</span><br><span class="line"></span><br><span class="line">setuptools.setup(</span><br><span class="line">    name=<span class="string">&#x27;agentio&#x27;</span>, <span class="comment"># Replace with your own username</span></span><br><span class="line">    version=<span class="string">&quot;1.1.4&quot;</span>,</span><br><span class="line">    author=<span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    author_email=<span class="string">&quot;xxxx@xx.com&quot;</span>,</span><br><span class="line">    description=<span class="string">&quot;it is a demo&quot;</span>,</span><br><span class="line">    license=<span class="string">&#x27;MIT&#x27;</span>,</span><br><span class="line">    url=<span class="string">&quot;http://xxx.demo.com&quot;</span>,</span><br><span class="line">    packages=setuptools.find_packages(),</span><br><span class="line">    install_requires=[<span class="string">&#x27;pika&#x27;</span>],</span><br><span class="line">    classifiers=[</span><br><span class="line">        <span class="string">&quot;Programming Language == Python == 3&quot;</span>,</span><br><span class="line">        <span class="string">&quot;License == OSI Approved == MIT License&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Operating System == OS Independent&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><h2 id="æ„å»ºåº“"><a href="#æ„å»ºåº“" class="headerlink" title="æ„å»ºåº“"></a>æ„å»ºåº“</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py build</span><br></pre></td></tr></table></figure><h2 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py sdist</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><p>æ¥ç€å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨å•¦ï¼</p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·æ“ä½œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å·¥å…·æ“ä½œ </tag>
            
            <tag> pythonåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>RabbitMQçš„å®‰è£…ä¸ä½¿ç”¨</title>
      <link href="2019/12/10/tool_operation/rabbitMQ/"/>
      <url>2019/12/10/tool_operation/rabbitMQ/</url>
      
        <content type="html"><![CDATA[<h1 id="RabbitMQçš„å®‰è£…ä¸ä½¿ç”¨"><a href="#RabbitMQçš„å®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="RabbitMQçš„å®‰è£…ä¸ä½¿ç”¨"></a>RabbitMQçš„å®‰è£…ä¸ä½¿ç”¨</h1><h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><h3 id="æ›´æ–°è½¯ä»¶æº"><a href="#æ›´æ–°è½¯ä»¶æº" class="headerlink" title="æ›´æ–°è½¯ä»¶æº"></a>æ›´æ–°è½¯ä»¶æº</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Erlang"><a href="#å®‰è£…Erlang" class="headerlink" title="å®‰è£…Erlang"></a>å®‰è£…Erlang</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get install erlang-nox     *# å®‰è£…Erlang*</span><br><span class="line">erl</span><br></pre></td></tr></table></figure><h3 id="æ·»åŠ å…¬é’¥"><a href="#æ·»åŠ å…¬é’¥" class="headerlink" title="æ·»åŠ å…¬é’¥"></a>æ·»åŠ å…¬é’¥</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget -O- https://www.rabbitmq.com/rabbitmq-release-signing-key.asc | sudo apt-key add -</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…RabbitMQ-server"><a href="#å®‰è£…RabbitMQ-server" class="headerlink" title="å®‰è£…RabbitMQ server"></a>å®‰è£…RabbitMQ server</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install rabbitmq-server</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…å®Œæˆåæ£€æŸ¥RabbitMQçŠ¶æ€"><a href="#å®‰è£…å®Œæˆåæ£€æŸ¥RabbitMQçŠ¶æ€" class="headerlink" title="å®‰è£…å®Œæˆåæ£€æŸ¥RabbitMQçŠ¶æ€"></a>å®‰è£…å®Œæˆåæ£€æŸ¥RabbitMQçŠ¶æ€</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep rabbit</span><br></pre></td></tr></table></figure><h2 id="å¼€å¯ï¼Œé‡å¯ï¼Œå…³é—­RabbitMQ"><a href="#å¼€å¯ï¼Œé‡å¯ï¼Œå…³é—­RabbitMQ" class="headerlink" title="å¼€å¯ï¼Œé‡å¯ï¼Œå…³é—­RabbitMQ"></a>å¼€å¯ï¼Œé‡å¯ï¼Œå…³é—­RabbitMQ</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service rabbitmq-server start# å¼€å¯</span><br><span class="line">service rabbitmq-server restart# é‡å¯</span><br><span class="line">service rabbitmq-server stop# å…³é—­</span><br></pre></td></tr></table></figure><h2 id="å¯ç”¨-webç«¯å¯è§†åŒ–æ“ä½œç•Œé¢"><a href="#å¯ç”¨-webç«¯å¯è§†åŒ–æ“ä½œç•Œé¢" class="headerlink" title="å¯ç”¨ webç«¯å¯è§†åŒ–æ“ä½œç•Œé¢"></a>å¯ç”¨ webç«¯å¯è§†åŒ–æ“ä½œç•Œé¢</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management# å¯ç”¨æ’ä»¶</span><br></pre></td></tr></table></figure><h2 id="æ·»åŠ ç®¡ç†ç”¨æˆ·"><a href="#æ·»åŠ ç®¡ç†ç”¨æˆ·" class="headerlink" title="æ·»åŠ ç®¡ç†ç”¨æˆ·"></a>æ·»åŠ ç®¡ç†ç”¨æˆ·</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rabbitmqctl add_user admin 123456   # å¢åŠ æ™®é€šç”¨æˆ· adminæ˜¯æˆ‘è®¾å®šçš„ç”¨æˆ·åï¼Œ123456æ˜¯æˆ‘è®¾å®šçš„å¯†ç </span><br></pre></td></tr></table></figure><h2 id="æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·"><a href="#æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·" class="headerlink" title="æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·"></a>æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rabbitmqctl list_users</span><br></pre></td></tr></table></figure><h2 id="ä¸ºç”¨æˆ·åˆ†é…ç®¡ç†å‘˜è§’è‰²"><a href="#ä¸ºç”¨æˆ·åˆ†é…ç®¡ç†å‘˜è§’è‰²" class="headerlink" title="ä¸ºç”¨æˆ·åˆ†é…ç®¡ç†å‘˜è§’è‰²"></a>ä¸ºç”¨æˆ·åˆ†é…ç®¡ç†å‘˜è§’è‰²</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo rabbitmqctl set_user_tags admin administrator    # ç»™adminè¿™ä¸ªç”¨æˆ·åˆ†é…è¶…çº§ç®¡ç†å‘˜è§’è‰² </span><br></pre></td></tr></table></figure><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">sudo rabbitmqctl start_app# å¯åŠ¨ç”¨ç”¨</span><br><span class="line">sudo rabbitmqctl stop_app# å…³é—­åº”ç”¨</span><br><span class="line">sudo rabbitmqctl status# èŠ‚ç‚¹çŠ¶æ€</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ·»åŠ ç”¨æˆ· ä¾‹å­ï¼šsudo rabbitmqctl add_user admin 123456  æ·»åŠ ä¸€ä¸ªåå­—ä¸ºadminçš„ç”¨æˆ·,å¯†ç ä¸º123456</span></span><br><span class="line">sudo rabbitmqctl add_user username password </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ é™¤ç”¨æˆ· ä¾‹å­ï¼šsudo rabbitmqctl delete_user admin åˆ é™¤åå­—ä¸ºadminçš„ç”¨æˆ·</span></span><br><span class="line">sudo rabbitmqctl delete_user username  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹ç”¨æˆ·å¯†ç  ä¾‹å­ï¼šsudo rabbitmqctl change_passowrd admin 456789 å°†adminç”¨æˆ·çš„å¯†ç ä¿®æ”¹ä¸º456789</span></span><br><span class="line">sudo rabbitmqctl change_passowrd username password </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¾ä¸ºç”¨æˆ·æƒé™ ä¾‹å­sudo rabbitmqctl set_permissions -p vhostpath admin <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> <span class="string">&quot;.*&quot;</span> è®¾ç½®adminç”¨æˆ·å…·æœ‰æœ€å¤§æƒé™</span></span><br><span class="line">sudo rabbitmqctl set_permissions -p vhostpath username &quot;.*&quot; &quot;.*&quot; &quot;.*&quot; </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¸…é™¤ç”¨æˆ·æƒé™ ä¾‹å­ï¼šsudo rabbitmqctl clear_permissions -p vhostpath admin æ¸…é™¤adminè¿™ä¸ªç”¨æˆ·çš„æ‰€æœ‰æƒé™</span></span><br><span class="line">sudo rabbitmqctl clear_permissions -p vhostpath username </span><br><span class="line"> </span><br><span class="line">sudo rabbitmqctl list_users  # æŸ¥çœ‹æ‰€æœ‰çš„ç”¨æˆ·</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºè™šæ‹Ÿä¸»æœºï¼Œæ³¨ï¼švhostpathå°±æ˜¯è™šæ‹Ÿä¸»æœºçš„çš„åç§°è·¯å¾„ï¼›ä¾‹å­ï¼šsudo rabbitmqctl add_vhost /test001  åˆ›å»ºåå­—test001çš„è™šæ‹Ÿä¸»æœºï¼Œè™šæ‹Ÿä¸»æœºçš„è·¯å¾„ä¸º/test001  åœ¨Rabbitmqä¸­é»˜è®¤çš„è™šæ‹Ÿä¸»æœºåç§°è·¯å¾„ä¸º/</span></span><br><span class="line">sudo rabbitmqctl add_vhost vhostpath</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">  åˆ é™¤è™šæ‹Ÿä¸»æœº ä¾‹å­sudo rabbitmqctl delete_vhost /test001 åˆ é™¤åç§°è·¯å¾„ä¸º/<span class="built_in">test</span>çš„è™šæ‹Ÿä¸»æœº</span></span><br><span class="line">sudo rabbitmqctl delete_vhost vhostpath </span><br><span class="line"></span><br><span class="line">sudo rabbitmqctl list_vhosts  # æŸ¥çœ‹æ‰€æœ‰çš„è™šæ‹Ÿä¸»æœº</span><br><span class="line"></span><br><span class="line">sudo rabbitmqctl list_permissions -p vhostpath  # æŸ¥çœ‹è™šæ‹Ÿä¸»æœºä¸Šæ‰€æœ‰çš„æƒé™ </span><br><span class="line"></span><br><span class="line">sudo rabbitmqctl list_permissions -p /  # æŸ¥çœ‹å¾æ‚¨ä¸»æœºåç§°è·¯å¾„ä¸º /çš„æ‰€æœ‰æƒé™</span><br><span class="line"></span><br><span class="line">sudo rabbitmqctl list_permissions -p /test001   # æŸ¥çœ‹å¾æ‚¨ä¸»æœºåç§°è·¯å¾„ä¸º /test001çš„æ‰€æœ‰æƒé™</span><br><span class="line"> </span><br><span class="line">sudo rabbitmqctl -p vhostpath purge_queue queuename   # æ¸…é™¤é˜Ÿåˆ—é‡Œçš„æ¶ˆæ¯ </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¸…é™¤è™šæ‹Ÿä¸»æœºä¸­åç§°è·¯å¾„ä¸º / ä¸­åç§°ä¸ºqueuen001é˜Ÿåˆ—é‡Œä¸­çš„æ‰€æœ‰æ¶ˆæ¯</span></span><br><span class="line">sudo rabbitmqctl -p / purge_queue queuen001  </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ¸…é™¤è™šæ‹Ÿä¸»æœºä¸­åç§°è·¯å¾„ä¸º /vhost001 ä¸­Queueé˜Ÿåˆ—åç§°ä¸ºqueuen001ä¸­çš„æ‰€æœ‰æ¶ˆæ¯</span></span><br><span class="line">sudo rabbitmqctl -p /vhost001 purge_queue queuen001  </span><br><span class="line"> </span><br><span class="line">sudo rabbitmqctl list_queues   # æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—ä¿¡æ¯</span><br><span class="line"> </span><br><span class="line"><span class="meta">#</span><span class="bash"> ç§»é™¤rabbitmqæ‰€æœ‰çš„æ•°æ®ï¼šæ³¨æ„éœ€è¦åœ¨rabbitmqctl stop_appä¹‹åæ‰èƒ½ä½¿ç”¨ å³ï¼šåœ¨å…³é—­rabbitmqåº”ç”¨åæ‰èƒ½æ“ä½œ</span></span><br><span class="line">sudo rabbitmqctl reset </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ç»„æˆé›†ç¾¤å‘½ä»¤</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è§£é‡Šï¼šä»¥åæˆ‘ä»¬è¦ç»„æˆRabbitmqé›†ç¾¤ç¯å¢ƒçš„æ„å»º,æˆ‘ä»¬æƒ³å‡ ä¸ªèŠ‚ç‚¹ç»„æˆä¸€ä¸ªé›†ç¾¤ï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªå‘½ä»¤</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> [--ram]çš„æ„æ€æ˜¯ å½“ä½ åŠ å…¥èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¯ä»¥æŒ‡å®šè¿™ä¸ªèŠ‚ç‚¹å­˜å‚¨çš„æ¨¡å¼æ˜¯ram ,ramå°±æ˜¯ä¸€ä¸ªå†…å­˜çº§åˆ«çš„å­˜å‚¨ï¼ˆå³ï¼šæˆ‘ä»¬çš„æ•°æ®éƒ½è½åœ¨å†…å­˜ä¸Šï¼‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœæ˜¯[--disc]è¡¨ç¤ºç£ç›˜å­˜å‚¨æ¨¡å¼ï¼ˆå³ï¼šæˆ‘ä»¬çš„æ•°æ®éƒ½è½åœ¨ç£ç›˜ä¸Šï¼‰ é»˜è®¤å°±æ˜¯ç£ç›˜å­˜å‚¨æ¨¡å¼</span></span><br><span class="line">sudo rabbitmqctl join_cluster &lt;clusternode&gt; [--ram] </span><br><span class="line"> </span><br><span class="line">sudo rabbitmqctl cluster_status  #æŸ¥çœ‹é›†ç¾¤çŠ¶æ€</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹é›†ç¾¤èŠ‚ç‚¹çš„å­˜å‚¨æ¨¡å¼ ï¼ˆæ¯”å¦‚æˆ‘ä»¬åœ¨åˆšåˆšåŠ å…¥é›†ç¾¤èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘å¿˜è®°äº†è¿™ä¸ªèŠ‚ç‚¹çš„å­˜å‚¨æ¨¡å¼ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤æ¥ä¿®æ”¹ï¼‰</span></span><br><span class="line">sudo rabbitmqctl change_cluster_node_type disc| ram </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¿˜è®°èŠ‚ç‚¹æˆ–è€…å« æ‘˜é™¤èŠ‚ç‚¹ ï¼ˆå¾ˆæœ‰æ„ä¹‰çš„ï¼‰</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¾‹å¦‚ï¼šä»¥åæˆ‘ä»¬åšrabbitmqé›†ç¾¤çš„æ—¶å€™ï¼Œé›†ç¾¤åœ¨è¿è¡Œä¸€æ®µæ—¶é—´åå‘ç°æœ‰äº›èŠ‚ç‚¹å¯èƒ½å¯åŠ¨ä¸èµ·æ¥äº†ï¼ˆæœ‰å¯èƒ½å®•æœºäº†ï¼‰ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤å°†<span class="comment"># é‚£äº›å¯åŠ¨ä¸èµ·æ¥çš„èŠ‚ç‚¹ç»™&quot;å¿˜è®°æ‰&quot; æˆ–è€…è¯´ç»™&quot;æ‘˜é™¤æ‰&quot; è¿™å°±æ˜¯æœ€ç®€å•çš„æ•…éšœè½¬ç§»</span></span></span><br><span class="line">sudo rabbitmqctl forget_cluster_node [--offline] </span><br><span class="line"> </span><br><span class="line">sudo rabbitmqctl rename_cluster_node oldnodeName newnodeName  # ä¿®æ”¹èŠ‚ç‚¹åç§°</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨pythonæ“ä½œRabbitMQ"><a href="#ä½¿ç”¨pythonæ“ä½œRabbitMQ" class="headerlink" title="ä½¿ç”¨pythonæ“ä½œRabbitMQ"></a>ä½¿ç”¨pythonæ“ä½œRabbitMQ</h2><h3 id="ä½¿ç”¨directæ¨¡å¼äº¤æ¢å™¨"><a href="#ä½¿ç”¨directæ¨¡å¼äº¤æ¢å™¨" class="headerlink" title="ä½¿ç”¨directæ¨¡å¼äº¤æ¢å™¨"></a>ä½¿ç”¨directæ¨¡å¼äº¤æ¢å™¨</h3><h4 id="å®šä¹‰ç”Ÿäº§è€…"><a href="#å®šä¹‰ç”Ÿäº§è€…" class="headerlink" title="å®šä¹‰ç”Ÿäº§è€…"></a>å®šä¹‰ç”Ÿäº§è€…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">)</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;d_ex&#x27;</span>, exchange_type=<span class="string">&#x27;direct&#x27;</span>, durable=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    message = <span class="string">f&#x27;time <span class="subst">&#123;i&#125;</span>&#x27;</span></span><br><span class="line">    channel.basic_publish(exchange=<span class="string">&#x27;d_ex&#x27;</span>,</span><br><span class="line">                          routing_key=<span class="string">&#x27;directProducer&#x27;</span>,</span><br><span class="line">                          body=message)</span><br><span class="line">    channel.basic_publish(exchange=<span class="string">&#x27;d_ex&#x27;</span>,</span><br><span class="line">                              routing_key=<span class="string">&#x27;directProducer&#x27;</span>,</span><br><span class="line">                              body=message)</span><br><span class="line">    print(message)</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰æ¶ˆè´¹è€…"><a href="#å®šä¹‰æ¶ˆè´¹è€…" class="headerlink" title="å®šä¹‰æ¶ˆè´¹è€…"></a>å®šä¹‰æ¶ˆè´¹è€…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">)</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;d_ex&#x27;</span>,exchange_type=<span class="string">&#x27;direct&#x27;</span>,durable=<span class="literal">True</span>)</span><br><span class="line">channel.queue_declare(queue=<span class="string">&#x27;consumerQueue&#x27;</span>,durable=<span class="literal">True</span>)</span><br><span class="line">channel.queue_bind(exchange=<span class="string">&#x27;d_ex&#x27;</span>, queue=<span class="string">&#x27;consumerQueue&#x27;</span>, routing_key=<span class="string">&#x27;directProducer&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties,body</span>):</span></span><br><span class="line">    channel.basic_ack(delivery_tag=method.delivery_tag)</span><br><span class="line">    print(body.decode())</span><br><span class="line">channel.basic_consume(queue=<span class="string">&#x27;consumerQueue&#x27;</span>, on_message_callback=callback)</span><br><span class="line">channel.start_consuming()</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨fanoutæ¨¡å¼äº¤æ¢å™¨"><a href="#ä½¿ç”¨fanoutæ¨¡å¼äº¤æ¢å™¨" class="headerlink" title="ä½¿ç”¨fanoutæ¨¡å¼äº¤æ¢å™¨"></a>ä½¿ç”¨fanoutæ¨¡å¼äº¤æ¢å™¨</h3><h4 id="å®šä¹‰ç”Ÿäº§è€…-1"><a href="#å®šä¹‰ç”Ÿäº§è€…-1" class="headerlink" title="å®šä¹‰ç”Ÿäº§è€…"></a>å®šä¹‰ç”Ÿäº§è€…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;logs&#x27;</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>)</span><br><span class="line"></span><br><span class="line">message = <span class="string">&#x27; &#x27;</span>.join(sys.argv[<span class="number">1</span>:]) <span class="keyword">or</span> <span class="string">&quot;info: Hello World!&quot;</span></span><br><span class="line"></span><br><span class="line">channel.basic_publish(exchange=<span class="string">&#x27;logs&#x27;</span>, routing_key=<span class="string">&#x27;&#x27;</span>, body=message)</span><br><span class="line">print(<span class="string">&quot;send successfully&quot;</span>)</span><br><span class="line">connection.close()</span><br></pre></td></tr></table></figure><h4 id="å®šä¹‰æ¶ˆè´¹è€…-1"><a href="#å®šä¹‰æ¶ˆè´¹è€…-1" class="headerlink" title="å®šä¹‰æ¶ˆè´¹è€…"></a>å®šä¹‰æ¶ˆè´¹è€…</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pika</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">connection = pika.BlockingConnection(</span><br><span class="line">    pika.ConnectionParameters(host=<span class="string">&#x27;localhost&#x27;</span>)</span><br><span class="line">)</span><br><span class="line">channel = connection.channel()</span><br><span class="line"></span><br><span class="line">channel.exchange_declare(exchange=<span class="string">&#x27;logs&#x27;</span>, exchange_type=<span class="string">&#x27;fanout&#x27;</span>,durable=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">channel.queue_declare(queue=<span class="string">&#x27;fanout_queue&#x27;</span>)</span><br><span class="line"></span><br><span class="line">channel.queue_bind(exchange=<span class="string">&#x27;logs&#x27;</span>,queue=<span class="string">&#x27;fanout_queue&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">callback</span>(<span class="params">ch, method, properties, body</span>):</span></span><br><span class="line">    msg = json.loads(body)</span><br><span class="line">    print(msg)</span><br><span class="line"></span><br><span class="line">channel.basic_consume(queue=<span class="string">&#x27;fanout_queue&#x27;</span>, on_message_callback=callback, auto_ack=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">channel.start_consuming()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> å·¥å…·æ“ä½œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ¶ˆæ¯ä¸­é—´ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
